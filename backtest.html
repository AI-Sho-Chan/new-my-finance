<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>バックテスト結果（Q1買い・Q4売り）</title>
  <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAAAFElEQVQoka3MMQ0AAAgDsKf9GQxgq0g1mHc3k3gAAAAASUVORK5CYII=" />
  <style>
    body{ background:#0f172a; color:#e5e7eb; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; }
    .wrap{ max-width: 1200px; margin: 16px auto; padding: 0 12px; }
    .topnav{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .navbtn{ padding:6px 10px; border-radius:8px; background:#1f2937; color:#e5e7eb; border:1px solid #374151; text-decoration:none; margin-right:6px; }
    .navbtn:hover{ background:#374151; }
    .navbtn.active{ background:#4f46e5; color:#fff; border-color:#4f46e5; }
    .card{ background:#111827; border:1px solid #374151; border-radius:8px; padding:12px; margin-bottom:16px; }
    .title{ font-weight:700; margin-bottom:8px; }
    .small{ color:#9ca3af; font-size:12px; }
    table{ width:max-content; border-collapse: collapse; }
    th,td{ padding:6px 8px; border-top:1px solid #374151; white-space:nowrap; }
    th{ color:#cbd5e1; font-weight:600; cursor:pointer; background:#111827; position:sticky; top:0; z-index:3; }
    .table-scroll{ overflow:auto; max-height:70vh; }
    .left1{ position:sticky; left:0; z-index:2; background:#111827; }
    .left2{ position:sticky; left:70px; z-index:2; background:#111827; }
    .w1{ width:70px; min-width:70px; text-align:left; }
    .w2{ width:90px; min-width:90px; text-align:left; }
    .num{ text-align:right; }
    .good{ color:#22c55e; }
    .bad{ color:#ef4444; }
    .hscroll{ overflow-x:auto; overflow-y:hidden; height:14px; background:#0f172a; border:1px solid #1f2937; border-radius:6px; margin:6px 0; }
    .hscroll > div{ height:1px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topnav" style="justify-content:flex-end">
      <div>
        <a class="navbtn" href="/NMY.html">ダッシュボード</a>
        <a class="navbtn" href="/NMY.html?tab=assets">資産</a>
        <a class="navbtn" href="/NMY.html?tab=analysis">分析</a>
        <a class="navbtn active" href="/backtest.html">バックテスト</a>
        <a class="navbtn" href="/NMY.html?tab=settings">設定</a>
      </div>
    </div>

    <div class="card">
      <div class="title">バックテスト結果（Q1買い・Q4売り）</div>
      <div class="small">分析ページを一度開くとイベントが生成されます。</div>
    </div>

    <div class="card" id="summaryCard"></div>

    <div class="card">
      <div class="small" id="desc"></div>
      <div id="topScroll" class="hscroll"><div id="topScrollInner"></div></div>
      <div id="tableScroll" class="table-scroll"><div id="table"></div></div>
    </div>
  </div>

  <script>
    let SORT = { key: 'ret', dir: 'desc' };
    let EVENTS = [];
    let NAME_MAP = {};

    function fmtDate(ts){ try{ const d=new Date(ts*1000); return isNaN(+d)? 'n/a': d.toISOString().slice(0,10); }catch(_){ return 'n/a'; } }
    async function openDB(){ return new Promise((res,rej)=>{ const req = indexedDB.open('nmy-analysis',1); req.onupgradeneeded = ()=>{ const db=req.result; if(!db.objectStoreNames.contains('events')) db.createObjectStore('events',{ keyPath:'id' }); }; req.onsuccess=()=>res(req.result); req.onerror=(e)=>rej(e); }); }
    async function getAllEvents(db){ return new Promise((res,rej)=>{ const tx=db.transaction('events','readonly'); const st=tx.objectStore('events'); const req=st.getAll(); req.onsuccess=()=>res(req.result||[]); req.onerror=(e)=>rej(e); }); }
    async function loadJPMap(){ try{ const r=await fetch('/data/jp-stocks.json?ts='+Date.now(),{cache:'no-store'}); const j=await r.json(); if(Array.isArray(j)){ j.forEach(x=>{ NAME_MAP[String(x.code)+'.T']= String(x.name||''); }); } }catch(_){ NAME_MAP = NAME_MAP || {}; } }
    function displayName(symbol){ return /\.T$/.test(symbol) ? (NAME_MAP[symbol]||symbol) : symbol; }

    function calcLatestDay(ev){ const ks=Object.keys(ev.returns||{}).map(k=>+k).filter(Number.isFinite); return ks.length? Math.max(...ks): 0; }
    function lastReturn(ev){ const d=calcLatestDay(ev); const r=ev.returns?.[d]; return (typeof r==='number' && isFinite(r))? r: -Infinity; }
    function comp(a,b,key,dir){ const s = (dir==='asc'? 1 : -1); const va = getVal(a,key), vb = getVal(b,key); if(va<vb) return -1*s; if(va>vb) return 1*s; return 0; }
    function getVal(ev,key){ if(key==='quad') return ev.quad; if(key==='symbol') return ev.symbol; if(key==='signalTs') return ev.signalTs; if(key==='side') return ev.side; if(key==='elapsed') return calcLatestDay(ev); if(key==='execPrice') return +ev.execPrice || 0; if(key==='ret') return lastReturn(ev); return 0; }

    function render(){
      const container = document.getElementById('table'); container.innerHTML='';
      const table=document.createElement('table'); const thead=document.createElement('thead'); const theadTr=document.createElement('tr');
      const headCells = ['Quad','Symbol','判定日','売買','経過日数','執行価格','騰落率'];
      headCells.forEach((label,idx)=>{ const th=document.createElement('th'); th.textContent=label; if(idx===0){ th.className='left1 w1'; } if(idx===1){ th.className='left2 w2'; } th.addEventListener('click',()=>{ const keys=['quad','symbol','signalTs','side','elapsed','execPrice','ret']; const k = keys[idx] || 'ret'; if(SORT.key===k) SORT.dir = (SORT.dir==='asc'?'desc':'asc'); else { SORT.key=k; SORT.dir='desc'; } render(); }); theadTr.appendChild(th); });
      thead.appendChild(theadTr); table.appendChild(thead);
      const tbody=document.createElement('tbody');
      const rows=[...EVENTS.filter(e=>e.quad==='Q1')].sort((a,b)=> comp(a,b, SORT.key, SORT.dir));
      rows.forEach(ev=>{
        const tr=document.createElement('tr');
        const c1=document.createElement('td'); c1.className='left1 w1'; c1.textContent=ev.quad; tr.appendChild(c1);
        const c2=document.createElement('td'); c2.className='left2 w2'; c2.textContent=displayName(ev.symbol); c2.title = ev.symbol; tr.appendChild(c2);
        const cells=[fmtDate(ev.signalTs), ev.side, String(calcLatestDay(ev)), (Number(ev.execPrice||0)).toFixed(2)];
        cells.forEach((v)=>{ const td=document.createElement('td'); td.className='num'; td.textContent=v; tr.appendChild(td); });
        const tdR=document.createElement('td'); const r=lastReturn(ev); tdR.className='num ' + (r>=0?'good':'bad'); tdR.textContent= (isFinite(r)? (r*100).toFixed(2)+'%' : '-'); tr.appendChild(tdR);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody); container.appendChild(table);
      const w = table.getBoundingClientRect().width; document.getElementById('topScrollInner').style.width = Math.max(0,w-10)+'px';
      const topS=document.getElementById('topScroll'); const mainS=document.getElementById('tableScroll');
      topS.onscroll=()=>{ mainS.scrollLeft = topS.scrollLeft; };
      mainS.onscroll=()=>{ topS.scrollLeft = mainS.scrollLeft; };
      const desc = document.getElementById('desc'); desc.textContent = `イベント数: ${rows.length}`;
    }

    async function buildBenchmark(){
      try{
        const u = `/api/yf/history?symbol=${encodeURIComponent('^GSPC')}&interval=1d&range=15y`;
        const r = await fetch(u, { cache:'no-store' });
        const j = await r.json();
        const res = j?.chart?.result?.[0] || {};
        const ts = res.timestamp || [];
        const q = res.indicators?.quote?.[0] || {};
        const close = q.close || [];
        const map = {}; for(let i=0;i<ts.length;i++){ const c=close[i]; if(Number.isFinite(c)) map[ts[i]] = c; }
        return { ts, close, map };
      } catch { return { ts:[], close:[], map:{} }; }
    }

    function summarize(events, bench){
      const horizons = [20,60,120];
      function statFor(kind){
        const evs = events.filter(e=>e.quad===kind);
        const out = {};
        for(const H of horizons){
          const arr = []; const ben = [];
          for(const ev of evs){
            const r = ev.returns?.[H]; if(typeof r==='number' && isFinite(r)) arr.push(r);
            if(bench && bench.ts && bench.ts.length){
              const t0 = ev.execTs; // seconds
              // find nearest index for t0 and t0+H*86400
              const t1 = t0 + H*86400;
              const f = (t)=>{ let best=null, bestd=1e18; for(const t2 of bench.ts){ const d=Math.abs(t2 - t); if(d<bestd){ bestd=d; best=t2; } } return best; };
              const a = bench.map[f(t0)]; const b = bench.map[f(t1)];
              if(Number.isFinite(a) && Number.isFinite(b) && a>0) ben.push(b/a - 1);
            }
          }
          const n = arr.length; const win = arr.filter(v=>v>0).length; const avg = n? arr.reduce((a,b)=>a+b,0)/n : 0;
          out[H] = { n, winRate: n? win/n : 0, avg, benchAvg: ben.length? ben.reduce((a,b)=>a+b,0)/ben.length : 0 };
        }
        return out;
      }
      return { Q1: statFor('Q1'), Q4: statFor('Q4') };
    }

    function renderSummary(stats){
      const el = document.getElementById('summaryCard');
      const fmtPct = (v)=> Number.isFinite(v)? (v*100).toFixed(1)+'%' : '-';
      const Hs = [20,60,120];
      const row = (label, st)=> Hs.map(h=>`<td class="num">${fmtPct(st[h].winRate)}</td><td class="num">${fmtPct(st[h].avg)}</td><td class="num">${fmtPct(st[h].avg - st[h].benchAvg)}</td>`).join('');
      const headHs = Hs.map(h=>`<th colspan="3" class="num">${h}日</th>`).join('');
      el.innerHTML = `<div class="title">バックテスト・サマリー（Q1とベンチ対比）</div>
        <div class="small">勝率・平均収益率・超過収益（対S&P500）</div>
        <div class="table-scroll"><table>
          <thead><tr><th></th>${headHs}</tr><tr><th></th>${Hs.map(_=>'<th class="num">勝率</th><th class="num">平均</th><th class="num">超過</th>').join('')}</tr></thead>
          <tbody>
            <tr><td>Q1</td>${row('Q1', stats.Q1)}</tr>
          </tbody>
        </table></div>`;
    }

    (async function(){
      try{
        await loadJPMap();
        const db = await openDB();
        EVENTS = await getAllEvents(db);
        const bench = await buildBenchmark();
        const stats = summarize(EVENTS, bench);
        renderSummary(stats);
        render();
      }catch(e){ console.error(e); }
    })();
  </script>
</body>
</html>
