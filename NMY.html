<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MyFinance</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAAAFElEQVQoka3MMQ0AAAgDsKf9GQxgq0g1mHc3k3gAAAAASUVORK5CYII=" />`r`n<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Use same-origin reverse proxy by default (works over tunnel)
    window.__YF_PROXY__ = window.__YF_PROXY__ || (window.location.origin + '/api/yf');
    (function(){
      const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
      const fetchWithTimeout = async (url, opts={})=>{
        const controller = new AbortController();
        const t = setTimeout(()=>controller.abort(), opts.timeout||8000);
        try{
          return await fetch(url, { ...opts, signal: controller.signal });
        } finally { clearTimeout(t); }
      };
      window.yfGetJSON = async function(pathWithQuery) {
        const base = window.__YF_PROXY__ || (window.location.origin + '/api/yf');
        const u = base + pathWithQuery + (pathWithQuery.includes('?') ? '&' : '?') + 'ts=' + Date.now();
        let lastErr;
        for (let i=0;i<3;i++){
          try{
            const res = await fetchWithTimeout(u, { cache: 'no-store', headers: { 'Accept': 'application/json' }, timeout: 8000 });
            if (!res.ok) throw new Error('HTTP ' + res.status);
            return await res.json();
          }catch(e){ lastErr=e; await sleep(300+ i*300); }
        }
        throw lastErr || new Error('fetch failed');
      }
    })();
  </script>
  <style>
    .animate-spin{animation:spin 1s linear infinite}@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  .q1-badge{display:none;margin-left:6px;padding:1px 4px;border-radius:4px;font-size:10px;background:#064e3b;color:#a7f3d0;border:1px solid #065f46;} .q1-active .q1-badge{display:inline-block;} .q1-active{box-shadow:0 0 0 2px rgba(16,185,129,0.35) inset, 0 0 12px rgba(16,185,129,0.25);}   .q1-badge{display:none;margin-left:6px;padding:1px 4px;border-radius:4px;font-size:10px;background:#064e3b;color:#a7f3d0;border:1px solid #065f46;} .q1-active .q1-badge{display:inline-block;} .q1-active{box-shadow:0 0 0 2px rgba(16,185,129,0.35) inset, 0 0 12px rgba(16,185,129,0.25);} </style>
</head>
<body class="bg-gray-900">
  <div id="root"></div>
  <script type="text/babel">
    const {useState,useEffect,useMemo,useRef} = React;
    const J = (s)=>decodeURIComponent(s);
    function AutoResizeAnalysis(){
      useEffect(()=>{
        const id = setInterval(()=>{
          try{
            const el = document.getElementById('analysisFrame');
            if(!el) return;
            const doc = el.contentDocument || el.contentWindow?.document;
            if(!doc) return;
            const h = Math.max(doc.body.scrollHeight, doc.documentElement.scrollHeight);
            if (h && Math.abs((parseInt(el.style.height||'0',10)||0) - h) > 5) { el.style.height = (h+10)+'px'; }
          }catch(_){ }
        }, 800);
        return ()=>clearInterval(id);
      },[]);
      return null;
    }

    const fmtDate = (ts)=>{ try{ const d=new Date(ts*1000); return isNaN(+d)? 'n/a' : d.toISOString().slice(0,10); }catch(_){ return 'n/a'; } };
    function AnalysisNotes(){
      const [lastDate,setLastDate] = useState('');
      useEffect(()=>{ (async()=>{
        try{
          const j = await yfGetJSON('/history?symbol=' + encodeURIComponent('^GSPC') + '&interval=1d&range=1y');
          const r = j?.chart?.result?.[0]; const ts = r?.timestamp||[]; if(ts.length){ setLastDate(fmtDate(ts[ts.length-1])); }
        }catch(_){ setLastDate(''); }
      })(); },[]);
      return (
        <div className="mt-3 text-sm text-gray-300 space-y-1">
          <div><b>用語:</b> F=63日リターンのZスコア、V=SMA50乖離のZスコア、A=(F+V)/2、Q1〜Q4はF×Vの象限。</div>
          <div><b>計算:</b> 各列は銘柄内で標準化（±3にクリップ）。Heatmapは列内パーセンタイルで着色。</div>
          <div><b>データ:</b> Yahoo Finance 日足（直近1年）。{lastDate? `最終日: ${lastDate}`: ''}</div>
        </div>
      );
    }

    // Icons
    const TrendingUp=()=> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>;
    const TrendingDown=()=> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>;
    const Loader=()=> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>;

// Fear & Greed widget
    const FearGreedWidget = () => {
      const [data,setData]=useState({ now:null, previousClose:null, history:[] });
      const boxRef=useRef(null); const chartRef=useRef(null); const seriesRef=useRef(null);
      useEffect(()=>{ let alive=true; const load=async()=>{ try{
            const u= '/api/fgi?ts='+Date.now();
            const r=await fetch(u,{headers:{'Accept':'application/json'}});
            if(!r.ok) throw new Error('fgi http '+r.status);
            const j=await r.json(); if(!alive) return;
            let hist = Array.isArray(j.history)? j.history: [];
            if(!hist.length){
              try{
                const rs=await fetch('/data/fgi/history.json?ts='+Date.now(),{cache:'no-store'});
                const jj=await rs.json();
                if(Array.isArray(jj)) hist = jj.map(x=>({ t:Number(x.x)||0, v:Number(x.y)||0 })).filter(x=>x.t&&Number.isFinite(x.v));
                else if(Array.isArray(jj.history)) hist = jj.history;
              }catch(_){ }
            }
            setData({ now:(typeof j.now==='number'? j.now: null), previousClose:(typeof j.previousClose==='number'? j.previousClose: null), history: hist });
          }catch(e){ /* noop */ } };
        load(); const t=setInterval(load, 5*60*1000); return ()=>{ alive=false; clearInterval(t); } },[]);
      useEffect(()=>{ (async()=>{ if(!boxRef.current) return; const L=await ensureLightweightCharts(); await new Promise(r=>requestAnimationFrame(r)); if(!chartRef.current){ const el=boxRef.current; const c=L.createChart(el,{ width:el.clientWidth||600, height:120, layout:{background:{type:'solid',color:'#1f2937'},textColor:'rgba(255,255,255,0.9)'}, grid:{vertLines:{color:'#374151'},horzLines:{color:'#374151'}}, timeScale:{ borderColor:'#4b5563', visible:true, timeVisible:false, secondsVisible:false, tickMarkSpacing:60, tickMarkFormatter:(time)=>{ const d=(typeof time==='object'&&time&&'year'in time)? new Date(Date.UTC(time.year, (time.month||1)-1, time.day||1)) : new Date((time+9*3600)*1000); const yy=String(d.getUTCFullYear()%100).padStart(2,'0'); const mm=String(d.getUTCMonth()+1).padStart(2,'0'); const dd=String(d.getUTCDate()).padStart(1,''); return `${yy}年${mm}月`; }}, localization:{ locale:'ja-JP' } }); chartRef.current=c; seriesRef.current=c.addLineSeries({ color:'#38bdf8', lineWidth:2 }); new ResizeObserver(([e])=>{ if(!e||!chartRef.current) return; chartRef.current.applyOptions({width:e.contentRect.width}); }).observe(el); }
        const s=seriesRef.current; if(s){
          const base=(data.history||[]).map(x=>({ time: Math.floor((x.t||0)/1000), value: Number(x.v)||0 }));
          const nowV = (typeof data.now==='number' && Number.isFinite(data.now)) ? data.now : null;
          const lastT = base.length? base[base.length-1].time : 0;
          const nowT = Math.floor(Date.now()/1000);
          const arr = nowV!=null ? [...base, { time: Math.max(lastT+60, nowT), value: nowV }] : base;
          s.setData(arr);
          // Dynamic tick label: short range => M/D, long range => YY/MM
          const useMD = arr.length < 90;
          chartRef.current?.applyOptions({ timeScale: { tickMarkFormatter: (time)=>{
            const d=(typeof time==='object'&&time&&'year'in time)? new Date(Date.UTC(time.year, (time.month||1)-1, time.day||1)) : new Date((time+9*3600)*1000);
            const yy=String(d.getUTCFullYear()%100).padStart(2,'0'); const mm=String(d.getUTCMonth()+1); const dd=String(d.getUTCDate());
            return useMD ? `${mm}/${dd}` : `${yy}/${mm}`;
          } } });
          chartRef.current?.timeScale().fitContent();
        }
      })(); },[data.history, data.now]);
      const score = (typeof data.now==='number' && Number.isFinite(data.now)) ? data.now : null;
      const prev = (typeof data.previousClose==='number' && Number.isFinite(data.previousClose)) ? data.previousClose : null;
      const label = (v)=> v==null? '-' : (v<=25?'極度恐怖': v<=45?'恐怖': v<55?'中立': v<75?'強欲': '極度強欲');
      const color = (v)=> v==null? 'text-gray-400' : (v<=25?'text-red-400': v<=45?'text-orange-400': v<55?'text-gray-300': v<75?'text-green-400':'text-emerald-400');
      const delta = (score!=null && prev!=null)? (score-prev) : null;
      const prog = Math.max(0, Math.min(100, score!=null? score: 0));
      const R=34, C=2*Math.PI*R, off=C*(1-prog/100);
      return (
        <div className="bg-gray-800 rounded p-3 grid grid-cols-1 md:grid-cols-3 gap-3 items-center">
          <div className="flex items-center space-x-3">
            <div className="relative w-28 h-28">
              <svg viewBox="0 0 80 80" className="w-28 h-28">
                <circle cx="40" cy="40" r="34" fill="none" stroke="#374151" strokeWidth="8" />
                <circle cx="40" cy="40" r="34" fill="none" stroke="currentColor" strokeWidth="8" strokeLinecap="round" className={color(score)} style={{ strokeDasharray: C, strokeDashoffset: off, transform: 'rotate(-90deg)', transformOrigin: '40px 40px' }} />
              </svg>
              <div className="absolute inset-0 flex flex-col items-center justify-center">
                <div className={`text-2xl font-bold ${color(score)}`}>{score!=null? Math.round(score): '-'}</div>
                <div className="text-[10px] text-gray-400">{label(score)}</div>
                <div className="text-[10px] text-gray-500">{delta!=null? `${delta>=0?'+':''}${Math.round(delta)}`:''}</div>
              </div>
            </div>
            <div>
              <div className="text-sm text-gray-300">Fear & Greed Index</div>
              <div className="text-xs text-gray-500">CNN (5分毎更新)</div>
            </div>
          </div>
          <div className="md:col-span-2">
            <div ref={boxRef} className="w-full h-[120px]"></div>
          </div>
        </div>
      );
    };

    // Indicators (VIX, S&P500, US10Y)
    const IndicatorsStrip = () => {
      const [q,setQ]=useState({});
      const syms=['^VIX','^GSPC','^N225','JPY=X','GC=F','BTC-JPY','^TNX'];
      useEffect(()=>{ (async()=>{ try{ const m=await fetchMarketData(syms); setQ(m); }catch{} })(); const t=setInterval(async()=>{ try{ const m=await fetchMarketData(syms); setQ(m); }catch{} }, 60000); return ()=>clearInterval(t); },[]);
      const Card=({sym,title,format})=>{ const x=q[sym]||{}; const price = x.price; const cp = x.changePercent; const up = (cp??0)>=0; const display = format? format(price) : (price!=null? price.toFixed(2): '-'); return (
        <a href={externalLinkFor(sym)} target="_blank" rel="noreferrer" className="flex-1 min-w-[140px] bg-gray-800 rounded p-3 hover:bg-gray-700 transition">
          <div className="text-xs text-gray-400 mb-1">{title}</div>
          <div className="text-lg font-bold">{display}</div>
          <div className={`text-sm ${up?'text-green-400':'text-red-400'}`}>{Number.isFinite(cp)? `${up?'+':''}${(cp*100).toFixed(2)}%`:'-'}</div>
        </a>
      ); };
      return (
        <div className="flex flex-wrap gap-3">
          <Card sym="^VIX" title="VIX" />
          <Card sym="^GSPC" title="S&P500" />
          <Card sym="^N225" title={J('%E6%97%A5%E7%B5%8C%E5%B9%B3%E5%9D%87')} />
          <Card sym="JPY=X" title={J('%E3%83%89%E3%83%AB%E5%86%86')} />
          <Card sym="GC=F" title={J('%E9%87%91')} />
          <Card sym="BTC-JPY" title={J('%E3%83%93%E3%83%83%E3%83%88%E3%82%B3%E3%82%A4%E3%83%B3')} />
          <Card sym="^TNX" title="US10Y" format={(p)=> (p!=null? (p/10).toFixed(2)+'%':'-')} />
        </div>
      );
    };

    // Lightweight Charts loader
    const LWC_URL='https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js';
    let __lwcPromise=null;
    const ensureLightweightCharts=()=>{
      if(window.LightweightCharts?.createChart) return Promise.resolve(window.LightweightCharts);
      if(__lwcPromise) return __lwcPromise;
      __lwcPromise=new Promise((resolve,reject)=>{
        const s=document.createElement('script'); s.id='lightweight-charts-standalone'; s.src=LWC_URL; s.async=true; s.crossOrigin='anonymous';
        s.addEventListener('load',()=>resolve(window.LightweightCharts),{once:true});
        s.addEventListener('error',()=>reject(new Error('Failed to load Lightweight Charts')),{once:true});
        document.head.appendChild(s);
      });
      return __lwcPromise;
    };

    // Defaults
    const DEFAULT_ITEMS = [
      {id:'^N225',   name:J('%E6%97%A5%E7%B5%8C%E5%B9%B3%E5%9D%87'), symbol:'^N225'},
      {id:'^GSPC',   name:'S&P500', symbol:'^GSPC'},
      {id:'7203.T',  name:J('%E3%83%88%E3%83%A8%E3%82%BF%E8%87%AA%E5%8B%95%E8%BB%8A'), symbol:'7203.T'},
      {id:'AAPL',    name:'Apple', symbol:'AAPL'},
      {id:'JPY=X',   name:J('%E3%83%89%E3%83%AB%E5%86%86'), symbol:'JPY=X'},
      {id:'^VIX',    name:J('VIX%E6%8C%87%E6%95%B0'), symbol:'^VIX'},
      {id:'BTC-JPY', name:J('%E3%83%93%E3%83%83%E3%83%88%E3%82%B3%E3%82%A4%E3%83%B3(%E5%86%86)'), symbol:'BTC-JPY'},
      {id:'^IXIC',   name:J('NASDAQ%E7%B7%8F%E5%90%88'), symbol:'^IXIC'},
      {id:'^RUT',    name:J('%E3%83%A9%E3%83%83%E3%82%BB%E3%83%AB2000'), symbol:'^RUT'},
      {id:'GC=F',    name:J('%E9%87%91'), symbol:'GC=F'},
      {id:'CL=F',    name:J('%E5%8E%9F%E6%B2%B9'), symbol:'CL=F'},
      {id:'1343.T',  name:J('%E6%9D%B1%E8%A8%BCREIT'), symbol:'1343.T'},
      {id:'8306.T',  name:J('%E4%B8%89%E8%8F%B1UFJFG'), symbol:'8306.T'},
      {id:'8316.T',  name:J('%E4%B8%89%E4%BA%95%E4%BD%8F%E5%8F%8BFG'), symbol:'8316.T'},
      {id:'7011.T',  name:J('%E4%B8%89%E8%8F%B1%E9%87%8D%E5%B7%A5'), symbol:'7011.T'},
      {id:'6501.T',  name:J('%E6%97%A5%E7%AB%8B'), symbol:'6501.T'},
      {id:'6702.T',  name:J('%E5%AF%8C%E5%A3%AB%E9%80%9A'), symbol:'6702.T'},
      {id:'6920.T',  name:J('%E3%83%AC%E3%83%BC%E3%82%B6%E3%83%BC%E3%83%86%E3%83%83%E3%82%AF'), symbol:'6920.T'},
      {id:'8035.T',  name:J('%E6%9D%B1%E4%BA%AC%E3%82%A8%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AD%E3%83%B3'), symbol:'8035.T'},
      {id:'8584.T',  name:J('%E3%82%B8%E3%83%A3%E3%83%83%E3%82%AF%E3%82%B9'), symbol:'8584.T'},
      {id:'7741.T',  name:'HOYA', symbol:'7741.T'},
      {id:'5401.T',  name:J('%E6%97%A5%E6%9C%AC%E8%A3%BD%E9%89%84'), symbol:'5401.T'},
      {id:'NVDA',    name:'NVIDIA', symbol:'NVDA'},
      {id:'AVGO',    name:J('%E3%83%96%E3%83%AD%E3%83%BC%E3%83%89%E3%82%B3%E3%83%A0'), symbol:'AVGO'},
      {id:'GOOGL',   name:'Alphabet', symbol:'GOOGL'},
      {id:'MSFT',    name:'Microsoft', symbol:'MSFT'},
      {id:'META',    name:'Meta', symbol:'META'}
    ];
    const NAME_MAP = Object.fromEntries(DEFAULT_ITEMS.map(x=>[x.symbol,x.name]));

        // JP index (symbol .T)
    let JP_INDEX = [];
    (async()=>{
      try {
        const res = await fetch('/data/jp-stocks.json?ts=' + Date.now(), { cache:'no-store' });
        const j = await res.json();
        if (Array.isArray(j)) {
          JP_INDEX = j.map(x=>({ code: String(x.code), symbol: String(x.code)+'.T', name: String(x.name||'') }));
          for (const it of JP_INDEX) { if (it.name) NAME_MAP[it.symbol] = it.name; }
        }
      } catch(e) { JP_INDEX = []; }
    })();

    // Settings
    const SETTINGS_LS = 'nmy.settings';
    const defaultSettings = { chart:{ defaultTF:'D', showBB:true }, yfProxy:'' };
    const loadSettings = ()=>{ try{ const j=JSON.parse(localStorage.getItem(SETTINGS_LS)||'null'); return j && typeof j==='object' ? { ...defaultSettings, ...j, chart:{ ...defaultSettings.chart, ...(j.chart||{}) } } : defaultSettings; }catch(_){ return defaultSettings; } };
    const saveSettings = (s)=>{ try{ localStorage.setItem(SETTINGS_LS, JSON.stringify(s)); }catch(_){} };
    // Apply saved proxy early if present
    try { const s = loadSettings(); if (s.yfProxy && typeof s.yfProxy==='string') { window.__YF_PROXY__ = s.yfProxy; } } catch(_){ }
// Helpers
    const externalLinkFor = (symbol) => /\.T$/.test(symbol)
      ? `https://kabutan.jp/stock/?code=${symbol.replace('.T','')}`
      : `https://finance.yahoo.com/quote/${encodeURIComponent(symbol)}`;
    const is24hSymbol = (s) => s==='JPY=X' || /-JPY$/.test(s) || /=X$/.test(s) || s==='BTC-JPY';
    const currencyFor = (s) => (s?.endsWith?.('.T') || s==='BTC-JPY' || /=X$/.test(s)) ? 'JPY' : 'USD';

    // JP normalization helpers (hiragana/katakana/fullwidth)
    const toKatakana = (str)=> String(str||'').replace(/[\u3041-\u3096]/g, ch => String.fromCharCode(ch.charCodeAt(0) + 0x60));
    // Very small romaji -> katakana converter (greedy)
    const romajiToKatakana = (input)=>{
      let s = String(input||'').toLowerCase();
      const map = {
        'kyo':'キョ','kya':'キャ','kyu':'キュ','gya':'ギャ','gyu':'ギュ','gyo':'ギョ',
        'sha':'シャ','shu':'シュ','sho':'ショ','sya':'シャ','syu':'シュ','syo':'ショ',
        'jya':'ジャ','jyu':'ジュ','jyo':'ジョ','ja':'ジャ','ju':'ジュ','jo':'ジョ',
        'cha':'チャ','chu':'チュ','cho':'チョ','cya':'チャ','cyu':'チュ','cyo':'チョ',
        'nya':'ニャ','nyu':'ニュ','nyo':'ニョ','hya':'ヒャ','hyu':'ヒュ','hyo':'ヒョ',
        'bya':'ビャ','byu':'ビュ','byo':'ビョ','pya':'ピャ','pyu':'ピュ','pyo':'ピョ',
        'mya':'ミャ','myu':'ミュ','myo':'ミョ','rya':'リャ','ryu':'リュ','ryo':'リョ',
        'shi':'シ','chi':'チ','tsu':'ツ','ti':'ティ','di':'ディ','du':'ドゥ','dzu':'ヅ',
        'fu':'フ','wi':'ウィ','we':'ウェ','who':'フオ','whi':'フィ','xa':'ァ','xi':'ィ','xu':'ゥ','xe':'ェ','xo':'ォ'
      };
      const basic = { a:'ア', i:'イ', u:'ウ', e:'エ', o:'オ', ka:'カ', ki:'キ', ku:'ク', ke:'ケ', ko:'コ', ga:'ガ', gi:'ギ', gu:'グ', ge:'ゲ', go:'ゴ', sa:'サ', si:'シ', su:'ス', se:'セ', so:'ソ', za:'ザ', zi:'ジ', zu:'ズ', ze:'ゼ', zo:'ゾ', ta:'タ', tu:'ツ', te:'テ', to:'ト', da:'ダ', de:'デ', do:'ド', na:'ナ', ni:'ニ', nu:'ヌ', ne:'ネ', no:'ノ', ha:'ハ', hi:'ヒ', hu:'フ', he:'ヘ', ho:'ホ', ba:'バ', bi:'ビ', bu:'ブ', be:'ベ', bo:'ボ', pa:'パ', pi:'ピ', pu:'プ', pe:'ペ', po:'ポ', ma:'マ', mi:'ミ', mu:'ム', me:'メ', mo:'モ', ya:'ヤ', yu:'ユ', yo:'ヨ', ra:'ラ', ri:'リ', ru:'ル', re:'レ', ro:'ロ', wa:'ワ', wo:'ヲ', n:'ン' };
      let out = '';
      const doubleCons = /([bcdfghjklmnpqrstvwxyz])\1/;
      while (s.length) {
        if (doubleCons.test(s)) { out+='ッ'; s=s.replace(doubleCons,(m,p)=>p); continue; }
        let hit = null;
        for (const len of [3,2,1]) {
          const seg = s.slice(0,len);
          if (map[seg]) { out += map[seg]; s = s.slice(len); hit = true; break; }
          if (basic[seg]) { out += basic[seg]; s = s.slice(len); hit = true; break; }
        }
        if (!hit) { out += s[0].match(/[a-z]/)? '' : s[0]; s = s.slice(1); }
      }
      return out || input;
    };
    const normalizeJP = (str)=>{
      const t = String(str||'').normalize('NFKC');
      if (/[a-z]/i.test(t)) return toKatakana(romajiToKatakana(t));
      return toKatakana(t);
    };

    // Search (Yahoo + local fallback)
    const searchSymbols = async (q) => {
      if (!q || !q.trim()) return [];
      const query = q.trim();
      const qN = normalizeJP(query);
      const qlen = query.length;
      const out = new Map(); // symbol -> { symbol, name, rank }
      const put = (sym, name, rank) => {
        const cur = out.get(sym);
        if (!cur || rank < cur.rank) out.set(sym, { symbol: sym, name, rank });
      };
      const isAsciiTicker = /^[A-Za-z][A-Za-z0-9.\-=]{0,9}$/.test(query);
      try {
        // broaden quotesCount; JP region + ja language to prefer Japanese listings
        const j = await yfGetJSON(`/search?q=${encodeURIComponent(query)}&quotesCount=40&newsCount=0&lang=ja-JP&region=JP`);
        const qs = Array.isArray(j?.quotes) ? j.quotes : [];
        for (const x of qs) {
          const sym = x?.symbol; if (!sym) continue;
          const name = x?.longname || x?.shortname || sym;
          // Prefer results that start with query in name/symbol
          let rank = 3;
          const nN = normalizeJP(name||'');
          if (nN.startsWith(qN) || sym.toLowerCase().startsWith(query.toLowerCase())) rank = 2;
          put(sym, name, rank);
        }
      } catch {}
      // If ASCII ticker-like or JP search was weak, try US region too
      try {
        if (isAsciiTicker || out.size < 3) {
          const u = `/search?q=${encodeURIComponent(query)}&quotesCount=40&newsCount=0&lang=en-US&region=US`;
          const j2 = await yfGetJSON(u);
          const qs2 = Array.isArray(j2?.quotes) ? j2.quotes : [];
          for (const x of qs2) {
            const sym = x?.symbol; if (!sym) continue;
            const name = x?.longname || x?.shortname || sym;
            let rank = isAsciiTicker && sym.toLowerCase().startsWith(query.toLowerCase()) ? 1 : 4;
            put(sym, name, rank);
          }
        }
      } catch {}
      // Local JP names (from our JP_INDEX and default catalog) as additional candidates
      // JP: 4-digit code match (e.g. 7203) or name match
      const is4 = /^\d{4}$/.test(query);
      if (is4) {
        const hit = JP_INDEX.find(i=>i.code===query);
        if (hit) put(hit.symbol, hit.name || hit.symbol, 0);
      }
      for (const it of JP_INDEX) {
        const nm = it.name || '';
        if (!nm) continue;
        const nN = normalizeJP(nm);
        if (qlen === 1) { if (nN.startsWith(qN)) put(it.symbol, nm, 1); }
        else if (qlen >= 2) { if (nN.includes(qN)) put(it.symbol, nm, 3); }
      }
      // Default items as extra fallback
      for (const it of DEFAULT_ITEMS) {
        const nm = it.name || '';
        const sym = it.symbol || '';
        const nameHit = (qlen===1) ? normalizeJP(nm).startsWith(qN) : normalizeJP(nm).includes(qN);
        const symHit = sym.toLowerCase().startsWith(query.toLowerCase());
        if (nameHit || symHit) put(sym, nm || sym, symHit ? 2 : (qlen===1?1:3));
      }
      return [...out.values()].sort((a,b)=> (a.rank-b.rank) || a.symbol.localeCompare(b.symbol));
    };

    // Assets Page
    const AssetsPage = ({watchItems=[], persistItems=(x)=>{}}) => {
      const LS_ASSETS='nmy.assets';
      const uid = ()=> 'id'+Math.random().toString(36).slice(2,10)+Date.now().toString(36);
      const load = ()=>{ try{ const j=JSON.parse(localStorage.getItem(LS_ASSETS)||'{}'); return (j&&typeof j==='object')? j: {}; }catch(_){ return {}; } };
      const init = load();
      const [cash,setCash]=useState(Array.isArray(init.cash)? init.cash : [{id:uid(), label:'現金', currency:'JPY', amount:0}]);
      const [holdings,setHoldings]=useState(Array.isArray(init.holdings)? init.holdings : []);
      const [quotes,setQuotes]=useState({});
      const [rate,setRate]=useState(null);
      const saveLS=()=>{ try{ localStorage.setItem(LS_ASSETS, JSON.stringify({ cash, holdings })); }catch(_){} };
      useEffect(()=>{ saveLS(); },[cash,holdings]);
      // fetch USDJPY always + symbols
      const lastDailyClose = async (symbol)=>{
        try{
          const j = await yfGetJSON(`/history?symbol=${encodeURIComponent(symbol)}&interval=1d&range=6mo`);
          const r = j?.chart?.result?.[0];
          const close = r?.indicators?.quote?.[0]?.close || [];
          for(let i=close.length-1;i>=0;i--){ const v=close[i]; if(Number.isFinite(v)) return v; }
        }catch(_){ }
        return null;
      };
      const refreshQuotes=async()=>{
        const syms = Array.from(new Set(holdings.map(h=>h.symbol).filter(Boolean)));
        const [m, closes, fxClose] = await Promise.all([
          syms.length? fetchMarketData(syms): Promise.resolve({}),
          Promise.all(syms.map(s=> lastDailyClose(s))),
          lastDailyClose('USDJPY=X')
        ]);
        const out = { ...quotes };
        syms.forEach((s,idx)=>{
          const name = m?.[s]?.name || out?.[s]?.name || NAME_MAP[s] || s;
          const price = (Number.isFinite(closes[idx])) ? closes[idx] : (out?.[s]?.price ?? null);
          out[s] = { price, change:0, changePercent:0, name };
        });
        setQuotes(out);
        if (Number.isFinite(fxClose)) setRate(fxClose);
      };
      useEffect(()=>{ refreshQuotes(); },[holdings.map(h=>h.symbol).join(',')]);
      useEffect(()=>{ const t = setInterval(refreshQuotes, 60000); return ()=>clearInterval(t); },[]);
      const r = rate ?? quotes['USDJPY=X']?.price ?? 150;
      const cashJPYSum = useMemo(()=> cash.filter(c=>c.currency==='JPY').reduce((a,c)=> a + (Number(c.amount)||0), 0),[cash]);
      const cashUSDSum = useMemo(()=> cash.filter(c=>c.currency==='USD').reduce((a,c)=> a + (Number(c.amount)||0), 0),[cash]);
      const cashTotalJPY = useMemo(()=> cashJPYSum + cashUSDSum * r, [cashJPYSum,cashUSDSum,r]);
      const stocksJPJPY = useMemo(()=> holdings.reduce((a,h)=>{ const cur=currencyFor(h.symbol); if(cur!=='JPY') return a; const q=quotes[h.symbol]||{}; const p=q.price||0; const qty=Number(h.qty)||0; return a + p*qty; },0),[holdings,quotes]);
      const stocksUSJPY = useMemo(()=> holdings.reduce((a,h)=>{ const cur=currencyFor(h.symbol); if(cur!=='USD') return a; const q=quotes[h.symbol]||{}; const p=q.price||0; const qty=Number(h.qty)||0; return a + p*qty*r; },0),[holdings,quotes,r]);
      const stocksTotalJPY = useMemo(()=> stocksJPJPY + stocksUSJPY,[stocksJPJPY,stocksUSJPY]);
      const totalJPY = useMemo(()=> cashTotalJPY + stocksTotalJPY,[cashTotalJPY,stocksTotalJPY]);

      const addCash = (cur='JPY')=> setCash([...cash,{id:uid(), label: cur==='USD'?'USD現金':'JPY現金', currency:cur, amount:0}]);
      const removeCash = (id)=> setCash(cash.filter(c=>c.id!==id));
      const moveRow = (arr,setArr,from,to)=>{ const a=[...arr]; const [m]=a.splice(from,1); a.splice(to,0,m); setArr(a); };
      // --- History (daily snapshots) and charts ---
      const LS_ASSETS_HIST='nmy.assets.history';
      const [history,setHistory]=useState(()=>{ try{ const j=JSON.parse(localStorage.getItem(LS_ASSETS_HIST)||'[]'); return Array.isArray(j)? j: []; }catch(_){ return []; } });
      const saveHistory=(h)=>{ try{ localStorage.setItem(LS_ASSETS_HIST, JSON.stringify(h)); }catch(_){} };
      const dayKey=(d)=>{ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; };
      useEffect(()=>{
        const now=new Date(); const key=dayKey(now);
        const ts=Math.floor(new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime()/1000);
        setHistory(prev=>{
          const h=Array.isArray(prev)? [...prev]:[];
          const snap={ key, ts, cashJPY:cashJPYSum, cashUSD:cashUSDSum*r, cashTotal:cashTotalJPY, stocksJP:stocksJPJPY, stocksUS:stocksUSJPY, stocksTotal:stocksTotalJPY, total:totalJPY };
          const i=h.findIndex(x=>x.key===key);
          if(i>=0){ h[i]=snap; } else { h.push(snap); }
          saveHistory(h); return h;
        });
      },[cashJPYSum,cashUSDSum,r,stocksJPJPY,stocksUSJPY,cashTotalJPY,stocksTotalJPY,totalJPY]);

      const latest = history.length? history[history.length-1]: null;
      const prevDay = (()=>{ if(!latest) return null; for(let i=history.length-2;i>=0;i--){ if(history[i].key!==latest.key) return history[i]; } return null; })();
      const pct=(cur,prev)=> (prev && prev>0)? ((cur-prev)/prev)*100 : null;
      const pctCash=pct(latest?.cashTotal||0, prevDay?.cashTotal||0);
      const pctStocks=pct(latest?.stocksTotal||0, prevDay?.stocksTotal||0);
      const pctTotal=pct(latest?.total||0, prevDay?.total||0);

      const [tfAssets,setTfAssets]=useState('D');
      const cashBoxRef=useRef(null), cashChartRef=useRef(null), cashSeriesRef=useRef({});
      const stockBoxRef=useRef(null), stockChartRef=useRef(null), stockSeriesRef=useRef({});
      const aggSeries=(hist,tf)=>{
        if(!Array.isArray(hist)||hist.length===0) return { cashTotal:[], cashJPY:[], cashUSD:[], stocksTotal:[], stocksJP:[], stocksUS:[] };
        const byKey=new Map();
        const push=(k,rec)=>{ const ex=byKey.get(k)||rec; if(!ex || (rec.ts>=ex.ts)) byKey.set(k,rec); };
        const pad2=(n)=>String(n).padStart(2,'0');
        for(const r of hist){
          const d=new Date(r.ts*1000);
          let k;
          if(tf==='M') k=`${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
          else if(tf==='W'){
            const dt=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            const day=(dt.getUTCDay()||7); dt.setUTCDate(dt.getUTCDate()+4-day); const y=dt.getUTCFullYear(); const y0=new Date(Date.UTC(y,0,1)); const wn=Math.ceil((((dt - y0)/86400000)+1)/7);
            k=`${y}-W${pad2(wn)}`;
          } else { k=dayKey(d); }
          push(k,{...r});
        }
        const outKeys=Array.from(byKey.keys()).sort();
        const toTime=(k)=>{
          if(tf==='M'){ const [y,m]=k.split('-'); return Math.floor(new Date(Number(y), Number(m)-1, 1).getTime()/1000); }
          if(tf==='W'){ const [y,w]=k.split('-W'); const jan1=new Date(Date.UTC(Number(y),0,1)); const ts=jan1.getTime()+ (Number(w)-1)*7*86400000; return Math.floor(ts/1000); }
          return Math.floor(new Date(k).getTime()/1000);
        };
        const cashTotal=[], cashJPY=[], cashUSD=[], stocksTotal=[], stocksJP=[], stocksUS=[];
        for(const k of outKeys){ const r=byKey.get(k); const t=toTime(k); cashTotal.push({time:t,value:Math.round(r.cashTotal)}); cashJPY.push({time:t,value:Math.round(r.cashJPY)}); cashUSD.push({time:t,value:Math.round(r.cashUSD)}); stocksTotal.push({time:t,value:Math.round(r.stocksTotal)}); stocksJP.push({time:t,value:Math.round(r.stocksJP)}); stocksUS.push({time:t,value:Math.round(r.stocksUS)}); }
        return { cashTotal, cashJPY, cashUSD, stocksTotal, stocksJP, stocksUS };
      };
      useEffect(()=>{
        let disposed=false; let ro1,ro2;
        (async()=>{
          const L=await ensureLightweightCharts(); await new Promise(r=>requestAnimationFrame(r)); if(disposed) return;
          const create=(el)=> L.createChart(el,{ width:el.clientWidth||800, height:260, layout:{background:{type:'solid',color:'#1f2937'},textColor:'rgba(255,255,255,0.9)'}, grid:{vertLines:{color:'#374151'},horzLines:{color:'#374151'}}, timeScale:{ borderColor:'#4b5563', visible:true, timeVisible:true, secondsVisible:false, tickMarkSpacing:75, tickMarkFormatter:(time)=>{ if(typeof time==='object'&&time&&'year'in time){ const yy=String(time.year%100).padStart(2,'0'); const mm=String(time.month).padStart(2,'0'); return `${yy}年${mm}月`; } const d=new Date((time+9*3600)*1000); const yy=String(d.getUTCFullYear()%100).padStart(2,'0'); const mm=String(d.getUTCMonth()+1).padStart(2,'0'); return `${yy}年${mm}月`; }}, localization:{ locale:'ja-JP' } });
          if(cashChartRef.current) cashChartRef.current.remove(); if(stockChartRef.current) stockChartRef.current.remove();
          cashChartRef.current=create(cashBoxRef.current); stockChartRef.current=create(stockBoxRef.current);
          const cc=cashChartRef.current; const sc=stockChartRef.current;
          cashSeriesRef.current={ total: cc.addLineSeries({color:'#38bdf8', lineWidth:2}), jpy: cc.addLineSeries({color:'rgba(74,222,128,0.9)', lineWidth:1, lineStyle:L.LineStyle.Dotted}), usd: cc.addLineSeries({color:'rgba(234,179,8,0.9)', lineWidth:1, lineStyle:L.LineStyle.Dotted}) };
          stockSeriesRef.current={ total: sc.addLineSeries({color:'#a78bfa', lineWidth:2}), jp: sc.addLineSeries({color:'rgba(59,130,246,0.9)', lineWidth:1, lineStyle:L.LineStyle.Dotted}), us: sc.addLineSeries({color:'rgba(244,63,94,0.9)', lineWidth:1, lineStyle:L.LineStyle.Dotted}) };
          ro1=new ResizeObserver(([e])=>{ if(!e||!cashChartRef.current) return; const {width}=e.contentRect; cashChartRef.current.applyOptions({width}); });
          ro2=new ResizeObserver(([e])=>{ if(!e||!stockChartRef.current) return; const {width}=e.contentRect; stockChartRef.current.applyOptions({width}); });
          ro1.observe(cashBoxRef.current); ro2.observe(stockBoxRef.current);
        })();
        return ()=>{ disposed=true; if(ro1) ro1.disconnect(); if(ro2) ro2.disconnect(); if(cashChartRef.current){ cashChartRef.current.remove(); cashChartRef.current=null; cashSeriesRef.current={}; } if(stockChartRef.current){ stockChartRef.current.remove(); stockChartRef.current=null; stockSeriesRef.current={}; } };
      },[]);
      useEffect(()=>{
        const agg=aggSeries(history, tfAssets);
        if(cashSeriesRef.current.total){ cashSeriesRef.current.total.setData(agg.cashTotal); cashSeriesRef.current.jpy.setData(agg.cashJPY); cashSeriesRef.current.usd.setData(agg.cashUSD); cashChartRef.current?.timeScale().fitContent(); }
        if(stockSeriesRef.current.total){ stockSeriesRef.current.total.setData(agg.stocksTotal); stockSeriesRef.current.jp.setData(agg.stocksJP); stockSeriesRef.current.us.setData(agg.stocksUS); stockChartRef.current?.timeScale().fitContent(); }
      },[history, tfAssets]);

      const SymbolEditor = ({row, onChange}) => {
        const [q,setQ]=useState(row.symbol||'');
        const [sugs,setSugs]=useState([]);
        const [open,setOpen]=useState(false);
        const [hi,setHi]=useState(0);
        const enrichTimer = useRef(null);
        useEffect(()=>{ let alive=true; const t=setTimeout(async()=>{ if(!q){ setSugs([]); return; } try{ const r=await searchSymbols(q); if(alive) setSugs(r); }catch{ if(alive) setSugs([]);} },200); return()=>{ clearTimeout(t); alive=false; }; },[q]);
        // Enrich suggestion names via /fund for JP tickers
        useEffect(()=>{
          if(!open || sugs.length===0) return;
          if (enrichTimer.current) { clearTimeout(enrichTimer.current); enrichTimer.current=null; }
          const need = sugs.filter(s=>s.symbol?.endsWith?.('.T'));
          let alive=true;
          enrichTimer.current=setTimeout(async()=>{
            try{
              const ups=await Promise.all(need.map(async s=>{ try{ const f=await yfGetJSON(`/fund?symbol=${encodeURIComponent(s.symbol)}`); return {sym:s.symbol,name:f?.longName||f?.shortName||s.name}; }catch{ return {sym:s.symbol,name:s.name}; } }));
              if(!alive) return; const map=new Map(sugs.map(x=>[x.symbol,{...x}]));
              for(const u of ups){ const x=map.get(u.sym); if(x){ x.name=u.name||x.name; map.set(u.sym,x);} }
              setSugs(Array.from(map.values()));
            }catch{}
          },150);
          return ()=>{ alive=false; if(enrichTimer.current){ clearTimeout(enrichTimer.current); enrichTimer.current=null; } };
        },[sugs,open]);
        const choose=(s)=>{ onChange({ symbol:s.symbol }); setQ(s.symbol); setOpen(false); };
        const onKey=(e)=>{
          if(!open || sugs.length===0) return;
          if(e.key==='ArrowDown'){ e.preventDefault(); setHi((hi+1)%sugs.length); }
          else if(e.key==='ArrowUp'){ e.preventDefault(); setHi((hi-1+sugs.length)%sugs.length); }
          else if(e.key==='Enter'){ e.preventDefault(); choose(sugs[hi]); }
        };
        return (
          <div className="relative">
            <input value={q} onFocus={()=>setOpen(true)} onBlur={()=> setTimeout(()=>setOpen(false),150)} onKeyDown={onKey} onChange={e=>setQ(e.target.value)} className="w-56 bg-gray-900 text-gray-100 rounded px-2 py-1" placeholder="AAPL / 7203 / トヨタ" />
            {open && sugs.length>0 && (
              <div className="absolute z-10 mt-1 w-80 max-h-60 overflow-auto bg-gray-800 border border-gray-700 rounded shadow">
                {sugs.map((s,idx)=>(
                  <button key={s.symbol} className={`block w-full text-left px-2 py-1 text-sm ${idx===hi?'bg-gray-700':''}`} onMouseEnter={()=>setHi(idx)} onMouseDown={(e)=>{ e.preventDefault(); }} onClick={()=>choose(s)}>
                    <span className="text-gray-200 mr-2">{s.symbol}</span>
                    <span className="text-gray-400">{s.name}</span>
                  </button>
                ))}
              </div>
            )}
          </div>
        );
      };

      const addHolding = ()=> setHoldings([...holdings,{id:uid(), symbol:'', qty:0, avgPrice:0}]);
      const removeHolding = (id)=> setHoldings(holdings.filter(h=>h.id!==id));

      const saveAndSyncDashboard = async ()=>{
        saveLS();
        try{
          const existing = new Set((watchItems||[]).map(w=>w.symbol));
          const addSyms = holdings.map(h=>h.symbol).filter(s=>s && !existing.has(s));
          if (addSyms.length===0) return;
          const items = [...watchItems];
          for (const s of addSyms){
            try{ const f=await fetchFundamentals(s); const display=f.longName||f.shortName||NAME_MAP[s]||s; items.push({ id:s, symbol:s, name:display }); }catch{ items.push({ id:s, symbol:s, name:NAME_MAP[s]||s }); }
          }
          persistItems(items);
        }catch{}
      };

      const fmt = (n)=> Number.isFinite(n)? Math.round(n).toLocaleString('ja-JP'): '-';

      const Card=({title,amount,pct})=> (
        <div className="bg-gray-800 rounded p-3">
          <div className="text-xs text-gray-400 mb-1">{title}</div>
          <div className="text-xl font-bold">{Math.round(amount).toLocaleString('ja-JP')} JPY</div>
          <div className={`text-sm ${pct==null?'text-gray-400':(pct>=0?'text-green-400':'text-red-400')}`}>{pct==null? '-' : `${pct>=0?'+':''}${pct.toFixed(2)}%`} {J('%E5%89%8D%E6%97%A5%E6%AF%94')}</div>
        </div>
      );

      return (
        <div className="space-y-6">
          <section>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
              <Card title={J('%E7%B7%8F%E8%B3%87%E7%94%A3')} amount={totalJPY} pct={pctTotal} />
              <Card title={J('%E7%8F%BE%E9%87%91%E9%A0%90%E9%87%91')} amount={cashTotalJPY} pct={pctCash} />
              <Card title={J('%E6%A0%AA%E5%BC%8F%E8%B3%87%E7%94%A3')} amount={stocksTotalJPY} pct={pctStocks} />
            </div>
          </section>

          <section className="bg-gray-800 rounded p-4">
            <div className="flex items-center justify-between mb-2">
              <h2 className="font-bold">{J('%E7%8F%BE%E9%87%91%2F%E5%82%99%E5%84%98%20%E6%99%82%E7%B3%BB%E5%88%97')}</h2>
              <div className="bg-gray-700 rounded-md p-1 flex space-x-1">
                {['D','W','M'].map(tf=> (
                  <button key={tf} onClick={()=>setTfAssets(tf)} className={`px-2 py-1 text-xs rounded ${tfAssets===tf?'bg-indigo-600 text-white':'text-gray-300'}`}>{tf==='D'?J('%E6%97%A5'):tf==='W'?J('%E9%80%B1'):J('%E6%9C%88')}</button>
                ))}
              </div>
            </div>
            <div ref={cashBoxRef} className="w-full h-[260px]"></div>
            <div className="text-xs text-gray-400 mt-1">{J('%E5%90%88%E8%A8%88')}: {Math.round(cashTotalJPY).toLocaleString('ja-JP')} JPY ／ {J('%E5%86%86%E9%A0%90%E9%87%91')}: {Math.round(cashJPYSum).toLocaleString('ja-JP')} ／ {J('%E3%83%89%E3%83%AB%E9%A0%90%E9%87%91%28JPY%20%E6%8F%9B%E7%AE%97%29')}: {Math.round(cashUSDSum*r).toLocaleString('ja-JP')}</div>
          </section>

          <section className="bg-gray-800 rounded p-4">
            <div className="flex items-center justify-between mb-2">
              <h2 className="font-bold">{J('%E6%A0%AA%E5%BC%8F%20%E6%99%82%E7%B3%BB%E5%88%97')}</h2>
              <div className="bg-gray-700 rounded-md p-1 flex space-x-1">
                {['D','W','M'].map(tf=> (
                  <button key={tf} onClick={()=>setTfAssets(tf)} className={`px-2 py-1 text-xs rounded ${tfAssets===tf?'bg-indigo-600 text-white':'text-gray-300'}`}>{tf==='D'?J('%E6%97%A5'):tf==='W'?J('%E9%80%B1'):J('%E6%9C%88')}</button>
                ))}
              </div>
            </div>
            <div ref={stockBoxRef} className="w-full h-[260px]"></div>
            <div className="text-xs text-gray-400 mt-1">{J('%E5%90%88%E8%A8%88')}: {Math.round(stocksTotalJPY).toLocaleString('ja-JP')} JPY ／ {J('%E6%97%A5%E6%9C%AC%E6%A0%AA')}: {Math.round(stocksJPJPY).toLocaleString('ja-JP')} ／ {J('%E7%B1%B3%E5%9B%BD%E6%A0%AA')}: {Math.round(stocksUSJPY).toLocaleString('ja-JP')}</div>
          </section>
          <section className="bg-gray-800 rounded p-4">
            <div className="flex items-center justify-between mb-2">
              <h2 className="font-bold">{J('%E7%8F%BE%E9%87%91%E3%83%BB%E9%A0%90%E9%87%91')}</h2>
              <div className="space-x-2">
                <button className="px-2 py-1 bg-gray-700 rounded" onClick={()=>addCash('JPY')}>{J('%E8%BF%BD%E5%8A%A0%28JPY%29')}</button>
                <button className="px-2 py-1 bg-gray-700 rounded" onClick={()=>addCash('USD')}>{J('%E8%BF%BD%E5%8A%A0%28USD%29')}</button>
              </div>
            </div>
            <div className="overflow-auto">
              <table className="w-full text-sm">
                <thead className="text-gray-400"><tr className="text-left">
                  <th className="px-2 py-1">{J('%E5%90%8D%E7%A7%B0')}</th>
                  <th className="px-2 py-1">{J('%E9%80%9A%E8%B2%A8')}</th>
                  <th className="px-2 py-1">{J('%E9%A1%8D')}</th>
                  <th className="px-2 py-1 text-right">{J('%E5%90%88%E8%A8%88%28JPY%29')}</th>
                  <th className="px-2 py-1"></th>
                </tr></thead>
                <tbody>
                  {cash.map((c,idx)=>{
                    const valJPY = (Number(c.amount)||0) * (c.currency==='USD'? r:1);
                    return (
                      <tr key={c.id} className="border-t border-gray-700" draggable onDragStart={(e)=>{ e.dataTransfer.setData('text/plain', String(idx)); }} onDragOver={(e)=>{ e.preventDefault(); }} onDrop={(e)=>{ const from=Number(e.dataTransfer.getData('text/plain')); moveRow(cash,setCash,from,idx); }}>
                        <td className="px-2 py-1"><input className="w-48 bg-gray-900 text-gray-100 rounded px-2 py-1" value={c.label} onChange={e=>{ const a=[...cash]; a[idx]={...c,label:e.target.value}; setCash(a); }} /></td>
                        <td className="px-2 py-1">
                          <select className="bg-gray-900 text-gray-100 rounded px-2 py-1" value={c.currency} onChange={e=>{ const a=[...cash]; a[idx]={...c,currency:e.target.value}; setCash(a); }}>
                            <option value="JPY">JPY</option>
                            <option value="USD">USD</option>
                          </select>
                        </td>
                        <td className="px-2 py-1"><input type="number" className="w-36 bg-gray-900 text-gray-100 rounded px-2 py-1" value={c.amount} onChange={e=>{ const a=[...cash]; a[idx]={...c,amount:Number(e.target.value)||0}; setCash(a); }} /></td>
                        <td className="px-2 py-1 text-right text-gray-100">{fmt(valJPY)}</td>
                        <td className="px-2 py-1"><button className="px-2 py-1 bg-red-600 hover:bg-red-500 rounded text-white text-xs" onClick={()=>removeCash(c.id)}>{J('%E5%89%8A%E9%99%A4')}</button></td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
            <div className="text-sm text-gray-400 mt-2">USD/JPY: {r? Number(r).toFixed(2): '-'}</div>
            <div className="text-right text-sm text-gray-300 mt-2">{J('%E7%8F%BE%E9%87%91%E5%90%88%E8%A8%88')} : {fmt(cashTotalJPY)} JPY</div>
          </section>

          <section className="bg-gray-800 rounded p-4">
            <div className="flex items-center justify-between mb-2">
              <h2 className="font-bold">{J('%E6%A0%AA%E5%BC%8F%E4%BF%9D%E6%9C%89')}</h2>
              <div className="flex space-x-2">
                <button className="px-2 py-1 bg-gray-700 rounded" onClick={addHolding}>{J('%E8%BF%BD%E5%8A%A0')}</button>
              </div>
            </div>
            <div className="overflow-auto">
              <table className="w-full text-sm">
                <thead className="text-gray-400"><tr className="text-left">
                  <th className="px-2 py-1">{J('%E9%8A%98%E6%9F%84')}</th>
                  <th className="px-2 py-1">{J('%E6%95%B0%E9%87%8F')}</th>
                  <th className="px-2 py-1">{J('%E5%B9%B3%E5%9D%87%E5%8F%96%E5%BE%97%E5%8D%98%E4%BE%A1')}</th>
                  <th className="px-2 py-1 text-right">{J('%E7%8F%BE%E5%80%A4')}</th>
                  <th className="px-2 py-1 text-right">{J('%E9%A8%B0%E8%90%BD%E7%8E%87')}</th>
                  <th className="px-2 py-1 text-right">{J('%E8%A9%95%E4%BE%A1%E9%A1%8D%28JPY%29')}</th>
                  <th className="px-2 py-1"></th>
                </tr></thead>
                <tbody>
                  {holdings.map((h,idx)=>{
                    const q=quotes[h.symbol]||{}; const price=q.price||0; const qty=Number(h.qty)||0; const cur=currencyFor(h.symbol); const rr=(cur==='USD')? r:1; const valJPY=price*qty*rr; const name=q.name||NAME_MAP[h.symbol]||''; const avg=Number(h.avgPrice)||0; const chgPct = avg>0 ? ((price-avg)/avg)*100 : null;
                    return (
                      <tr key={h.id} className="border-t border-gray-700" draggable onDragStart={(e)=>{ e.dataTransfer.setData('text/plain', String(idx)); }} onDragOver={(e)=>{ e.preventDefault(); }} onDrop={(e)=>{ const from=Number(e.dataTransfer.getData('text/plain')); moveRow(holdings,setHoldings,from,idx); }}>
                        <td className="px-2 py-1">
                          <div className="flex flex-col">
                            <SymbolEditor row={h} onChange={(upd)=>{ const a=[...holdings]; a[idx]={...h,...upd}; setHoldings(a); }} />
                            <div className="text-xs text-gray-400 truncate max-w-[18rem]" title={name}>{name}</div>
                          </div>
                        </td>
                        <td className="px-2 py-1"><input type="number" className="w-24 bg-gray-900 text-gray-100 rounded px-2 py-1" value={h.qty} onChange={e=>{ const a=[...holdings]; a[idx]={...h,qty:Number(e.target.value)||0}; setHoldings(a); }} /></td>
                        <td className="px-2 py-1"><input type="number" className="w-28 bg-gray-900 text-gray-100 rounded px-2 py-1" value={h.avgPrice} onChange={e=>{ const a=[...holdings]; a[idx]={...h,avgPrice:Number(e.target.value)||0}; setHoldings(a); }} /></td>
                        <td className="px-2 py-1 text-right text-gray-200">{price? price.toFixed(2): '-'}</td>
                        <td className={`px-2 py-1 text-right ${chgPct==null?'text-gray-400':(chgPct>=0?'text-green-400':'text-red-400')}`}>{chgPct==null? '-' : `${chgPct>=0?'+':''}${chgPct.toFixed(2)}%`}</td>
                        <td className="px-2 py-1 text-right text-gray-100">{fmt(valJPY)}</td>
                        <td className="px-2 py-1"><button className="px-2 py-1 bg-red-600 hover:bg-red-500 rounded text-white text-xs" onClick={()=>removeHolding(h.id)}>{J('%E5%89%8A%E9%99%A4')}</button></td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
            <div className="text-right text-sm text-gray-300 mt-2">{J('%E6%A0%AA%E5%BC%8F%E5%90%88%E8%A8%88')} : {fmt(stocksTotalJPY)} JPY</div>
          </section>

          <div className="flex items-center justify-between">
            <div className="text-sm text-gray-300">{J('%E5%90%88%E8%A8%88')} : {fmt(totalJPY)} JPY</div>
            <div className="space-x-2">
              <button className="px-3 py-2 bg-indigo-600 rounded" onClick={saveAndSyncDashboard}>{J('%E4%BF%9D%E5%AD%98')}</button>
              <button className="px-3 py-2 bg-gray-700 rounded" onClick={refreshQuotes}>{J('%E6%9C%80%E6%96%B0%E5%8C%96')}</button>
            </div>
          </div>
        </div>
      );
    };

    const SettingsPage = ({settings,setSettings}) => {
      const [local,setLocal]=useState(()=> ({ ...settings }));
      const update=(path,val)=>{ const next={...local}; if(path==='yfProxy') next.yfProxy=val; if(path==='defaultTF') next.chart={...next.chart, defaultTF:val}; if(path==='showBB') next.chart={...next.chart, showBB:!!val}; setLocal(next); };
      return (
        <div className="space-y-6">
          <section className="bg-gray-800 rounded p-4">
            <h2 className="font-bold mb-2">{J('%E8%A8%AD%E5%AE%9A')}</h2>
            <label className="block text-sm text-gray-300 mb-2">YF Proxy URL
              <input className="mt-1 w-full bg-gray-900 text-gray-100 rounded px-3 py-2" value={local.yfProxy} onChange={e=>update('yfProxy', e.target.value)} placeholder="http://127.0.0.1:8787/api/yf" />
            </label>
            <div className="flex items-center space-x-4 mt-2">
              <div className="text-sm text-gray-300">{J('%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88TF')}</div>
              {['D','W','M'].map(tf=> (
                <label key={tf} className={`px-2 py-1 rounded cursor-pointer ${local.chart.defaultTF===tf?'bg-indigo-600':''}`}>
                  <input type="radio" className="mr-1" checked={local.chart.defaultTF===tf} onChange={()=>update('defaultTF',tf)} />{tf}
                </label>
              ))}
            </div>
            <label className="mt-3 inline-flex items-center space-x-2 text-sm text-gray-300">
              <input type="checkbox" checked={!!local.chart.showBB} onChange={e=>update('showBB', e.target.checked)} />
              <span>{J('%E3%83%9C%E3%83%AA%E3%83%B3%E3%82%B8%E3%83%A3%E3%83%BC%E3%81%AE%E8%A1%A8%E7%A4%BA')}</span>
            </label>
            <div className="mt-4 space-x-2">
              <button className="px-3 py-2 bg-indigo-600 rounded" onClick={()=>{ setSettings(local); saveSettings(local); if(local.yfProxy) window.__YF_PROXY__=local.yfProxy; }}>{J('%E4%BF%9D%E5%AD%98')}</button>
              <button className="px-3 py-2 bg-gray-700 rounded" onClick={()=>{ const d=loadSettings(); setLocal(d); }}>{J('%E5%85%83%E3%81%AB%E6%88%BB%E3%81%99')}</button>
            </div>
          </section>
        </div>
      );
    };

    // Quotes (+ 24h adjustment)
    const asNum = x => (typeof x === 'number' && Number.isFinite(x)) ? x : undefined;
    const fetch24hDelta = async (symbol) => {
      try {
        const j = await yfGetJSON(`/history?symbol=${encodeURIComponent(symbol)}&interval=1h&range=2d`);
        const r = j?.chart?.result?.[0] || {};
        const ts = r?.timestamp || [];
        const qt = r?.indicators?.quote?.[0] || {};
        const close = qt?.close || [];
        let iLast = -1; for (let i=ts.length-1;i>=0;i--){ const c=close[i]; if (Number.isFinite(c)) { iLast=i; break; } }
        if (iLast<0) throw new Error('no last');
        const iPrev = Math.max(0, iLast-24);
        const last = close[iLast]; const prev = close[iPrev];
        if (!Number.isFinite(last) || !Number.isFinite(prev) || prev<=0) throw new Error('bad 24h');
        return { change: last - prev, changePercent: (last - prev) / prev };
      } catch(e){ return null; }
    };
    const fetchMarketData = async (symbols) => {
      try {
        const j = await yfGetJSON(`/quote?symbols=${encodeURIComponent(symbols.join(','))}`);
        const list = j?.quoteResponse?.result || [];
        const out = {};
        for (const q of list) {
          const price = asNum(q.regularMarketPrice);
          const prev = asNum(q.regularMarketPreviousClose);
          const change = (price!=null && prev!=null) ? price - prev : 0;
          const changePercent = (price!=null && prev>0) ? (price-prev)/prev : 0;
          const tCandidates = [q.postMarketTime, q.regularMarketTime, q.preMarketTime].map(asNum).filter(x=>x!=null);
          const lastTs = tCandidates.length ? Math.max(...tCandidates) : undefined;
          out[q.symbol] = { price, change, changePercent, name: q.longName || q.shortName || NAME_MAP[q.symbol] || q.symbol, lastTs };
        }
        for(const s of symbols){ if(!out[s]) out[s] = { price:0, change:0, changePercent:0, name:NAME_MAP[s]||s }; }
        const s24 = symbols.filter(is24hSymbol);
        await Promise.all(s24.map(async s=>{ const d = await fetch24hDelta(s); if(d && out[s]) { out[s].change=d.change; out[s].changePercent=d.changePercent; } }));
        // Enrich lastTs with intraday (15m, 5d) so we don't stick to open time
        await Promise.all(symbols.map(async (s)=>{
          try{
            const h = await yfGetJSON(`/history?symbol=${encodeURIComponent(s)}&interval=15m&range=5d`);
            const r = h?.chart?.result?.[0];
            const ts = r?.timestamp || [];
            const close = r?.indicators?.quote?.[0]?.close || [];
            for(let i=ts.length-1;i>=0;i--){ const c=close[i]; if(Number.isFinite(c)){ const t=ts[i]; if(!out[s]) out[s]={}; out[s].lastTs = Math.max(out[s].lastTs||0, t); break; } }
          }catch(_){ }
        }));
        // Fallback: use last daily close from history when price is 0/null (e.g., ZZTEST dummy)
        await Promise.all(symbols.map(async (s) => {
          const rec = out[s]; if (!rec || (rec.price && Number.isFinite(rec.price))) return;
          try {
            const h = await yfGetJSON(`/history?symbol=${encodeURIComponent(s)}&interval=1d&range=1mo`);
            const r = h?.chart?.result?.[0];
            const close = r?.indicators?.quote?.[0]?.close || [];
            for (let i=close.length-1;i>=0;i--) { const v=close[i]; if (Number.isFinite(v)) { rec.price=v; rec.change=0; rec.changePercent=0; break; } }
          } catch {}
        }));
        return out;
      } catch(e){
        return symbols.reduce((a,s)=>{ a[s]={ price:0, change:0, changePercent:0, name:NAME_MAP[s]||s }; return a; },{});
      }
    };
    // History summary for MA-based trend and last updated
    const fetchHistorySummary = async (symbol) => {
      try {
        const j = await yfGetJSON(`/history?symbol=${encodeURIComponent(symbol)}&interval=1d&range=1y`);
        const r = j?.chart?.result?.[0] || {};
        const ts = r?.timestamp || [];
        const qt = r?.indicators?.quote?.[0] || {};
        const close = qt?.close || [];
        let lastTs = null; const closes = [];
        for (let i = 0; i < ts.length; i++) {
          const c = close[i];
          if (Number.isFinite(c)) { closes.push(c); lastTs = ts[i]; }
        }
        const ma = (arr,n)=>{ if(arr.length<n) return null; let s=0; for(let i=arr.length-n;i<arr.length;i++) s+=arr[i]; return s/n; };
        const ma50 = ma(closes,50); const ma200 = ma(closes,200);
        let trend="flat"; if (Number.isFinite(ma50) && Number.isFinite(ma200)) {
          const diff = (ma50 - ma200) / ma200; trend = diff > 0.001 ? "up" : diff < -0.001 ? "down" : "flat";
        }
        return { lastTs, trend };
      } catch(e) { return { lastTs:null, trend:"flat" } }
    };

    // Full history for chart modal
    const fetchHistoricalData = async (symbol, timeframe) => {
      const tf = timeframe === 'W' ? { interval: '1wk', range: '10y' }
               : timeframe === 'M' ? { interval: '1mo', range: 'max' }
               :                      { interval: '1d',  range: '5y' };
      const j = await yfGetJSON(`/history?symbol=${encodeURIComponent(symbol)}&interval=${tf.interval}&range=${tf.range}`);
      const r = j?.chart?.result?.[0];
      const ts = r?.timestamp || [];
      const qt = r?.indicators?.quote?.[0] || {};
      const open = qt.open || [], high = qt.high || [], low = qt.low || [], close = qt.close || [], volume = qt.volume || [];
      const out = [];
      for (let i=0;i<ts.length;i++){
        const o=open[i], h=high[i], l=low[i], c=close[i], v=volume[i];
        if ([o,h,l,c].some(x=>x==null || !isFinite(x))) continue;
        out.push({ time: ts[i], open:o, high:h, low:l, close:c, value:isFinite(v)?v:0, color: c>=o? 'rgba(0,150,136,0.2)' : 'rgba(255,82,82,0.2)' });
      }
      return out;
    };
    // Fundamentals (names)
    const fetchFundamentals = async (symbol) => {
      try {
        const f = await yfGetJSON(`/fund?symbol=${encodeURIComponent(symbol)}`);
        return { longName: f?.longName || null, shortName: f?.shortName || null };
      } catch { return { longName:null, shortName:null }; }
    };

    const TrendingIcon=({trend})=> trend==='up'?<TrendingUp/>: trend==='down'?<TrendingDown/>:<span className="text-gray-400 text-xs">—</span>;

    const StockCard=({item,onClick,onRemove,draggable,onDragStart,onDragOver,onDrop,signalsMap})=>{
      const changeAbs = Math.abs(item.changePercent??0);
      const hasTrend = typeof item.trend === 'string' && item.trend.length>0;
      const bigMove = changeAbs >= 0.04; // 4% 以上の変動
      const isUp = (item.changePercent??0) >= 0;
      const ringClass = bigMove
        ? (isUp
            ? ' ring-2 ring-green-400/50 shadow-[0_0_12px_rgba(34,197,94,0.35)] '
            : ' ring-2 ring-red-400/50 shadow-[0_0_12px_rgba(248,113,113,0.35)] ')
        : '';
      return (
        <div className={("bg-gray-800 rounded-lg p-3 shadow-lg cursor-pointer relative " + ringClass).trim()} data-symbol={item.symbol} onClick={onClick} draggable={draggable} onDragStart={onDragStart} onDragOver={onDragOver} onDrop={onDrop}>
          {bigMove && (
            <div className={`pointer-events-none absolute inset-y-0 left-0 w-1 ${isUp?'bg-green-400/80':'bg-red-400/80'} rounded-l`}></div>
          )}
          <button className="absolute right-2 top-2 text-gray-500 hover:text-white text-lg" title={J('%E5%89%8A%E9%99%A4')} onClick={(e)=>{ e.stopPropagation(); onRemove?.(); }}>&times;</button>
          <div className="flex justify-between items-start pr-6">
            <div className="min-w-0">
              <h3 className="text-sm font-bold text-gray-100 truncate" title={item.name}>{item.name}<span className="q1-badge">Q1</span></h3>
              <p className="text-xs text-gray-400">{item.symbol}</p>
              {/* Signal badges */}
              {Array.isArray(signalsMap?.[item.symbol]?.signals) && signalsMap[item.symbol].signals.length>0 && (
                <div className="mt-1 flex flex-wrap gap-1">
                  {signalsMap[item.symbol].signals.slice(-3).map((sg,idx)=> (
                    <span key={idx} className={`text-[10px] px-1.5 py-0.5 rounded border ${sg.type==='押' ? 'bg-indigo-500/10 text-indigo-300 border-indigo-500/30' : sg.type==='52H+' ? 'bg-emerald-500/10 text-emerald-300 border-emerald-500/30' : 'bg-amber-500/10 text-amber-300 border-amber-500/30'}`}>{sg.type}</span>
                  ))}
                </div>
              )}
            </div>
            <div className="flex flex-col items-end">
              <div className={`text-lg ${hasTrend?(item.trend==='up'?'text-green-400':'text-red-400'):'text-gray-400'}`}><TrendingIcon trend={hasTrend?item.trend:'flat'}/></div>
              <div className="text-[10px] text-gray-400">{item.lastUpdated? (()=>{ const d=new Date(item.lastUpdated); const dd=String(d.getDate()); const hh=String(d.getHours()).padStart(2,'0'); const mm=String(d.getMinutes()).padStart(2,'0'); return `${J('%E6%9C%80%E7%B5%82')} ${dd}${J('%E6%97%A5')}${hh}:${mm}`; })(): ''}</div>
            </div>
          </div>
          <div className="flex items-center justify-center py-2">
            <div className={`text-3xl font-bold ${(item.changePercent??0)>=0?'text-green-500':'text-red-500'}`}>{((item.changePercent??0)>=0?'+':'-')}{(changeAbs*100).toFixed(1)}%</div>
          </div>
          <div className="text-xs text-gray-400 pt-2 border-t border-gray-700">
            <a href={externalLinkFor(item.symbol)} target="_blank" rel="noreferrer" className="text-gray-300 hover:text-gray-100">{J('%E6%8C%87%E6%A8%99')}</a>
          </div>
        </div>
      );
    };

    const LS = { items:'nmy.watch.items', sort:'nmy.watch.sort' };

    const SearchAdd = ({onPick}) => {
      const [q,setQ]=useState('');
      const [sugs,setSugs]=useState([]);
      const enrichTimer = useRef(null);
      useEffect(()=>{
        let alive=true; const t=setTimeout(async()=>{ if(!q.trim()){ setSugs([]); return; } try{ const r=await searchSymbols(q.trim()); if(alive) setSugs(r); }catch(e){ if(alive) setSugs([]);} }, 300);
        return()=>{ clearTimeout(t); alive=false; };
      },[q]);
      // Enrich JP suggestions with /fund names (Japanese) to avoid mojibake/local gaps
      useEffect(()=>{
        if(!sugs || sugs.length===0) return;
        if (enrichTimer.current) { clearTimeout(enrichTimer.current); enrichTimer.current=null; }
        const hasJP=(s)=>/[\u3040-\u30ff\u3400-\u9fff]/.test(s||'');
        const need = sugs.filter(s=>s.symbol?.endsWith?.('.T') && !hasJP(s.name||''));
        if (need.length===0) return;
        let alive=true;
        enrichTimer.current = setTimeout(async()=>{
          try {
            const updates = await Promise.all(need.map(async s=>{ try{ const f=await yfGetJSON(`/fund?symbol=${encodeURIComponent(s.symbol)}`); const name=f?.longName||f?.shortName||s.name; return {sym:s.symbol,name}; }catch{ return {sym:s.symbol,name:s.name}; } }));
            if(!alive) return;
            const map=new Map(sugs.map(x=>[x.symbol,{...x}]));
            for(const u of updates){ const x=map.get(u.sym); if(x){ x.name=u.name||x.name; map.set(u.sym,x);} }
            setSugs(Array.from(map.values()));
          } catch{}
        }, 150);
        return ()=>{ alive=false; if(enrichTimer.current){ clearTimeout(enrichTimer.current); enrichTimer.current=null; } };
      },[sugs]);
      return (
        <div className="relative w-full max-w-md">
          <input value={q} onChange={e=>setQ(e.target.value)} placeholder={J('%E9%8A%98%E6%9F%84%E5%90%8D%2F%E3%83%86%E3%82%A3%E3%83%83%E3%82%AB%E3%83%BC%2F%E3%82%B3%E3%83%BC%E3%83%89%E3%81%A7%E8%BF%BD%E5%8A%A0')} className="w-full bg-gray-800 text-gray-200 placeholder-gray-500 rounded px-3 py-2 outline-none" />
          {sugs.length>0 && (
            <div className="absolute z-10 mt-1 w-full bg-gray-800 border border-gray-700 rounded shadow-lg max-h-64 overflow-auto">
              {sugs.map(s=> (
                <button key={s.symbol} onClick={()=>{ onPick(s.symbol, s.name); setQ(''); setSugs([]); }} className="w-full text-left px-3 py-2 hover:bg-gray-700 text-sm">
                  <span className="text-gray-200 font-semibold mr-2">{s.symbol}</span>
                  <span className="text-gray-400">{s.name}</span>
                </button>
              ))}
            </div>
          )}
        </div>
      );
    };
    // JP code/name search (JP専用)
    const JPStockAdd = ({onPick}) => {
      const [q,setQ]=useState('');
      const [sugs,setSugs]=useState([]);
      useEffect(()=>{
        const v=q.trim();
        if(!v){ setSugs([]); return; }
        let list=[];
        if (/^\d{4}$/.test(v)) {
          const code=v; const hit = JP_INDEX.find(i=>i.code===code);
          list = hit? [hit] : [{code, symbol: `${code}.T`, name: NAME_MAP[`${code}.T`]||code}];
        } else {
          const vN = normalizeJP(v);
          const starts = (s)=> normalizeJP(s).startsWith(vN);
          const contains = (s)=> normalizeJP(s).includes(vN);
          const calcRank = (nm, sym)=>{
            if (!nm) return 9999;
            if (starts(nm)) return 0;
            if (v.length>=2 && contains(nm)) {
              const idx = nm.indexOf(v);
              return 10 + Math.max(0, idx); // earlier match is better
            }
            return 9999;
          };
          list = JP_INDEX
            .filter(i=> v.length<=1 ? starts(i.name||'') : contains(i.name||''))
            .map(i=> ({ ...i, _rank: calcRank(i.name, i.symbol) - (NAME_MAP[i.symbol]?2:0) }))
            .sort((a,b)=> (a._rank-b._rank) || (a.name||'').length - (b.name||'').length || a.code.localeCompare(b.code));
        }
        (async()=>{
          let out = list;
          if (out.length===0 && !/^\d{4}$/.test(v)) {
            try {
              const remote = await searchSymbols(v);
              const jpOnly = remote.filter(s=>s.symbol?.endsWith?.('.T'));
              const filt = (v.length<=1)
                ? jpOnly.filter(s=> normalizeJP(s.name||'').startsWith(normalizeJP(v)))
                : jpOnly.filter(s=> normalizeJP(s.name||'').includes(normalizeJP(v)));
              // rank remote too: prefix first, then shorter name
              out = filt
                .map(s=> ({ code: s.symbol.replace(/\.T$/,''), symbol: s.symbol, name: s.name, _rank: (s.name||'').startsWith(v)?0:10 + Math.max(0,(s.name||'').indexOf(v)) }))
                .sort((a,b)=> (a._rank-b._rank)|| (a.name||'').length - (b.name||'').length || a.code.localeCompare(b.code));
            } catch {}
          }
          setSugs(out);
        })();
      },[q]);
      // Enrich names via /fund in case local names are mojibake/empty
      useEffect(()=>{
        if(!sugs || sugs.length===0) return; let alive=true;
        const hasJP=(s)=>/[\u3040-\u30ff\u3400-\u9fff]/.test(s||'');
        const need = sugs.filter(s=>s.symbol?.endsWith?.('.T') && !hasJP(s.name||''));
        (async()=>{
          try{
            const updates = await Promise.all(need.map(async s=>{ try{ const f=await yfGetJSON(`/fund?symbol=${encodeURIComponent(s.symbol)}`); const name=f?.longName||f?.shortName||s.name; return {sym:s.symbol,name}; }catch{ return {sym:s.symbol,name:s.name}; } }));
            if(!alive) return; const map=new Map(sugs.map(x=>[x.symbol,{...x}]));
            for(const u of updates){ const x=map.get(u.sym); if(x){ x.name=u.name||x.name; map.set(u.sym,x);} }
            setSugs(Array.from(map.values()));
          }catch{}
        })();
        return ()=>{ alive=false };
      },[sugs]);
      return (
        <div className="relative w-full max-w-md">
          <input value={q} onChange={e=>setQ(e.target.value)} placeholder={J('%E6%97%A5%E6%9C%AC%E6%A0%AA%EF%BC%9A%E8%A8%BC%E5%88%B8%E3%82%B3%E3%83%BC%E3%83%89%2F%E6%97%A5%E6%9C%AC%E8%AA%9E%E5%90%8D%E6%A4%9C%E7%B4%A2')} className="w-full bg-gray-800 text-gray-200 placeholder-gray-500 rounded px-3 py-2 outline-none" />
          {sugs.length>0 && (
            <div className="absolute z-10 mt-1 w-full bg-gray-800 border border-gray-700 rounded shadow-lg max-h-64 overflow-auto">
              {sugs.map(s=> (
                <button key={s.symbol} onClick={()=>{ onPick(s.symbol, s.name); setQ(''); setSugs([]); }} className="w-full text-left px-3 py-2 hover:bg-gray-700 text-sm">
                  <span className="text-gray-200 font-semibold mr-2">{s.code}</span>
                  <span className="text-gray-400">{s.name}</span>
                </button>
              ))}
            </div>
          )}
        </div>
      );
    };
    // Notify embedded Analysis (React) about watchlist changes
    function __notifyAnalysisWatch(items){
      try{
        var f = document.getElementById('analysisFrame');
        if(!f || !f.contentWindow) return;
        var payload = { type:'nmy.watch.update', items: (Array.isArray(items)? items: []).map(function(w){ return { symbol: String(w.symbol||''), name: String(w.name||w.symbol||'') }; }) };
        f.contentWindow.postMessage(payload, window.location.origin);
      }catch(_){}
    }

    const App=()=>{
      const uniqueBySymbol = (arr=[])=>{ const seen=new Set(); const out=[]; for(const x of arr){ const s=x?.symbol; if(!s||seen.has(s)) continue; seen.add(s); out.push({ id: x.id||s, ...x }); } return out; };
      const loadItems = ()=>{ try{ const j=JSON.parse(localStorage.getItem(LS.items)||'[]'); let arr = Array.isArray(j)? j: []; const before = arr.length; arr = arr.filter(w=>w && w.symbol !== 'ZZTEST'); if(arr.length!==before){ try{ localStorage.setItem(LS.items, JSON.stringify(arr)); }catch(_){} } if(arr.length) return uniqueBySymbol(arr); }catch(_){} return uniqueBySymbol(DEFAULT_ITEMS); };
      const [watchItems,setWatchItems]=useState(()=> loadItems());
      const [draftItems,setDraftItems]=useState(()=> loadItems());
      const [watchlist,setWatchlist]=useState([]);
      const [isLoading,setIsLoading]=useState(true);
      const [sortMode,setSortMode]=useState(()=> localStorage.getItem(LS.sort) || 'none');
      const [dragIndex,setDragIndex]=useState(null);
      const [selected,setSelected]=useState(null);
      const [modalOpen,setModalOpen]=useState(false);
      const [signals,setSignals]=useState({});
      const [page,setPage]=useState('dashboard');
      const [settings,setSettings]=useState(()=> loadSettings());

      useEffect(()=>{ document.title = J('%E3%83%9E%E3%83%8D%E3%83%BC%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%A3%E3%83%BC'); },[]);

      const persistItems = (items)=>{ const clean=uniqueBySymbol(items); setWatchItems(clean); setDraftItems(clean); try{ localStorage.setItem(LS.items, JSON.stringify(clean)); }catch(_){} try{ __notifyAnalysisWatch(clean); }catch(_){} };

      useEffect(()=>{
        (async()=>{
          setIsLoading(true);
          try{
            const syms = (sortMode==='none' ? draftItems : watchItems).map(i=>i.symbol);
            const market = await fetchMarketData(syms);
            const [hist, funds] = await Promise.all([
              Promise.all(syms.map(s=>fetchHistorySummary(s))),
              Promise.all(syms.map(s=>fetchFundamentals(s)))
            ]);
            const histBy = Object.fromEntries(syms.map((s,i)=>[s,hist[i]]));
            const fundBy = Object.fromEntries(syms.map((s,i)=>[s,funds[i]]));
            const base = (sortMode==='none' ? draftItems : watchItems);
            const uniqBase = Array.from(new Map(base.map(x=>[x.symbol,x])).values());
            setWatchlist(uniqBase.map(i=>{
              const d=market[i.symbol]||{}; const h=histBy[i.symbol]||{}; const f=fundBy[i.symbol]||{};
              const ts = d.lastTs || h.lastTs || null;
              return { ...i, ...d,
                name: f.longName || f.shortName || d.name || NAME_MAP[i.symbol] || i.name,
                trend:h.trend,
                lastUpdated: ts? new Date(ts*1000): null };
            }));
            // Fetch signals for these symbols
            try {
              const r = await fetch('/api/signals', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ symbols: uniqBase.map(x=>x.symbol) }) });
              if (r.ok) {
                const s = await r.json();
                setSignals(s||{});
              } else {
                setSignals({});
              }
            } catch(_){ setSignals({}); }
          } finally { setIsLoading(false); }
        })();
      },[watchItems, draftItems, sortMode]);

      return (
        <div className="bg-gray-900 text-white min-h-screen">
          <div className="container mx-auto px-4 pb-20">
            <header className="py-4 flex items-center justify-between">
              <div>
                <h1 className="text-2xl font-bold text-gray-100">{J('%E3%83%9E%E3%83%8D%E3%83%BC%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%A3%E3%83%BC')}</h1>
                <p className="text-sm text-gray-400">{J('%E3%81%82%E3%81%AA%E3%81%9F%E3%81%AE%E8%B3%87%E7%94%A3%E3%81%A8%E7%9B%B8%E5%A0%B4%E3%82%92%E3%80%81%E6%89%8B%E5%85%83%E3%81%A7%E6%8A%8A%E6%8F%A1%E3%80%82')}</p>
              </div>
              <nav className="flex space-x-2">
                <button onClick={()=>setPage('dashboard')} className={`px-3 py-2 rounded ${page==='dashboard'?'bg-indigo-600 text-white':'bg-gray-800 text-gray-300'}`}>{J('%E3%83%80%E3%83%83%E3%82%B7%E3%83%A5%E3%83%9C%E3%83%BC%E3%83%89')}</button>
                <button onClick={()=>setPage('assets')} className={`px-3 py-2 rounded ${page==='assets'?'bg-indigo-600 text-white':'bg-gray-800 text-gray-300'}`}>{J('%E8%B3%87%E7%94%A3')}</button>
                <button onClick={()=>setPage('analysis')} className={`px-3 py-2 rounded ${page==='analysis'?'bg-indigo-600 text-white':'bg-gray-800 text-gray-300'}`}>{J('%E5%88%86%E6%9E%90')}</button>
                <a href="/backtest.html" className="px-3 py-2 rounded bg-gray-800 text-gray-300 hover:bg-gray-700">{J('%E3%83%90%E3%83%83%E3%82%AF%E3%83%86%E3%82%B9%E3%83%88')}</a>
                <button onClick={()=>setPage('settings')} className={`px-3 py-2 rounded ${page==='settings'?'bg-indigo-600 text-white':'bg-gray-800 text-gray-300'}`}>{J('%E8%A8%AD%E5%AE%9A')}</button>
              </nav>
            </header>

            {page==='analysis' && (
              <section className="bg-gray-800 rounded p-2">
                <div className="w-full">
                  <iframe id="analysisFrame" src="/analysis.html" title="analysis" className="w-full bg-gray-900 rounded border border-gray-700" style={{ height: 600, overflow: 'hidden' }} onLoad={(e)=>{ try{ const el=e.target; const doc=el.contentDocument||el.contentWindow?.document; if(doc){ const h=Math.max(doc.body.scrollHeight, doc.documentElement.scrollHeight); if(h) el.style.height=(h+4)+'px'; } }catch(_){} }}></iframe>
                </div>
              </section>
            )}
{page==='dashboard' && (
              <div className="mb-3 space-y-3">
                <FearGreedWidget />
                <IndicatorsStrip />
              </div>
            )}

            {page==='dashboard' && (
            <div className="flex items-center justify-between mb-3">
              <div className="flex flex-col md:flex-row md:space-x-2 gap-2 w-full">
                <SearchAdd onPick={async (symbol,name)=>{ const exists = watchItems.some(w=>w.symbol===symbol); if(exists) return; const f=await fetchFundamentals(symbol); const display=f.longName||f.shortName||name||NAME_MAP[symbol]||symbol; const next=[...watchItems, {id:symbol, symbol, name:display }]; setWatchItems(next); setDraftItems(next); try{ localStorage.setItem(LS.items, JSON.stringify(next)); }catch(_){} try{ __notifyAnalysisWatch(next); }catch(_){} }}/>
                <JPStockAdd onPick={async (symbol,name)=>{ const exists = watchItems.some(w=>w.symbol===symbol); if(exists) return; const f=await fetchFundamentals(symbol); const display=f.longName||f.shortName||name||NAME_MAP[symbol]||symbol; const next=[...watchItems, {id:symbol, symbol, name:display }]; setWatchItems(next); setDraftItems(next); try{ localStorage.setItem(LS.items, JSON.stringify(next)); }catch(_){} try{ __notifyAnalysisWatch(next); }catch(_){} }}/>
              </div>
              <div className="flex items-center space-x-2">
                <select value={sortMode} onChange={e=>{ const v=e.target.value; setSortMode(v); try{ localStorage.setItem(LS.sort,v); }catch(_){} }} className="bg-gray-800 text-gray-200 text-sm px-3 py-2 rounded">
                  <option value="none">{J('%E6%89%8B%E5%8B%95%E9%A0%86')}</option>
                  <option value="changeAsc">{J('%E5%AF%BE%E5%89%8D%E6%97%A5%E6%AF%94%20%E6%98%87%E9%A0%86')}</option>
                  <option value="changeDesc">{J('%E5%AF%BE%E5%89%8D%E6%97%A5%E6%AF%94%20%E9%99%8D%E9%A0%86')}</option>
                  <option value="trendUpFirst">{J('%E4%B8%8A%E6%98%87%E3%83%88%E3%83%AC%E3%83%B3%E3%83%89%E5%84%AA%E5%85%88')}</option>
                  <option value="trendDownFirst">{J('%E4%B8%8B%E9%99%8D%E3%83%88%E3%83%AC%E3%83%B3%E3%83%89%E5%84%AA%E5%85%88')}</option>
                </select>
                <button onClick={()=>persistItems(draftItems)} className="px-3 py-2 bg-indigo-600 rounded text-sm">{J('%E4%B8%A6%E3%81%B3%E9%A0%86%E3%82%92%E4%BF%9D%E5%AD%98')}</button>
                <button onClick={()=>{ 
                  // Apply current displayed order as manual order
                  let list=[...watchlist];
                  const num=v=>(typeof v==='number' && isFinite(v))?v:0;
                  if (sortMode==='changeAsc') list.sort((a,b)=> num(a.changePercent) - num(b.changePercent));
                  else if (sortMode==='changeDesc') list.sort((a,b)=> num(b.changePercent) - num(a.changePercent));
                  else if (sortMode==='trendUpFirst') { const up=list.filter(x=>x.trend==='up').sort((a,b)=> num(a.changePercent)-num(b.changePercent)); const rest=list.filter(x=>x.trend!=='up'); list=[...up,...rest]; }
                  else if (sortMode==='trendDownFirst') { const down=list.filter(x=>x.trend==='down').sort((a,b)=> num(b.changePercent)-num(a.changePercent)); const rest=list.filter(x=>x.trend!=='down'); list=[...down,...rest]; }
                  const ordered = list.map(it=> ({ id: it.symbol, symbol: it.symbol, name: it.name }));
                  setDraftItems(ordered); setSortMode('none');
                }} className="px-3 py-2 bg-gray-700 rounded text-sm">{J('%E5%85%83%E3%81%AB%E6%88%BB%E3%81%99')}</button>
              </div>
            </div>
            )}

            {page==='dashboard' && (
            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
              {isLoading
                ? (<div className="col-span-2 md:col-span-3 lg:col-span-4 flex justify-center items-center h-40"><Loader/><span className="ml-3 text-gray-400">{J('%E5%B8%82%E5%A0%B4%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%8F%96%E5%BE%97%E4%B8%AD...')}</span></div>)
                : ( ()=>{
                    let list = [...watchlist];
                    const num = v => (typeof v==='number' && isFinite(v)) ? v : 0;
                    if (sortMode==='changeAsc') list.sort((a,b)=> num(a.changePercent) - num(b.changePercent));
                    else if (sortMode==='changeDesc') list.sort((a,b)=> num(b.changePercent) - num(a.changePercent));
                    else if (sortMode==='trendUpFirst') {
                      const up = list.filter(x=>x.trend==='up').sort((a,b)=> num(a.changePercent) - num(b.changePercent));
                      const rest = list.filter(x=>x.trend!=='up');
                      list = [...up, ...rest];
                    } else if (sortMode==='trendDownFirst') {
                      const down = list.filter(x=>x.trend==='down').sort((a,b)=> num(b.changePercent) - num(a.changePercent));
                      const rest = list.filter(x=>x.trend!=='down');
                      list = [...down, ...rest];
                    }
                    return list.map((item,idx)=> (
                     <StockCard key={`${item.symbol}-${idx}`}
                       item={item}
                       signalsMap={signals}
                       onClick={()=>{ setSelected(item); setModalOpen(true); }}
                       onRemove={()=>{ if(!confirm(`Delete ${item.symbol}?`)) return; const after = draftItems.filter(w=>w.symbol!==item.symbol); setDraftItems(after); setWatchItems(after); try{ localStorage.setItem(LS.items, JSON.stringify(after)); }catch(_){} try{ __notifyAnalysisWatch(after); }catch(_){} }}
                       draggable={sortMode==='none'}
                      onDragStart={(e)=>{ e.dataTransfer?.setData('text/plain', String(idx)); setDragIndex(idx); }}
                      onDragOver={(e)=>{ if(sortMode==='none'){ e.preventDefault(); }}}
                      onDrop={()=>{ if(sortMode==='none' && dragIndex!=null){ const arr=[...draftItems]; const [m]=arr.splice(dragIndex,1); arr.splice(idx,0,m); setDraftItems(arr); setDragIndex(null);} }}
                    />
                  ));
                  })()
              }
            </div>
            )}
            {page==='assets' && (<AssetsPage watchItems={watchItems} persistItems={persistItems} />)}
            {page==='settings' && (<SettingsPage settings={settings} setSettings={setSettings} />)}
          </div>
          {modalOpen && selected && <StockChartModal stock={selected} signalsMap={signals} onClose={()=>{ setModalOpen(false); setSelected(null); }} />}
        </div>
      );
    };

    // Chart modal component
    const StockChartModal=({stock,onClose,signalsMap})=>{
      const containerRef=useRef(null);
      const chartRef=useRef(null);
      const seriesRef=useRef({});
      const [timeframe,setTimeframe]=useState(()=> (loadSettings().chart?.defaultTF || 'D'));
      const [loading,setLoading]=useState(true);

      useEffect(()=>{
        if(!stock) return; let disposed=false; let ro;
        (async()=>{
          setLoading(true);
          try{
            const L=await ensureLightweightCharts();
            await new Promise(r=>requestAnimationFrame(r));
            if(disposed||!containerRef.current) return;
            if(chartRef.current){ chartRef.current.remove(); chartRef.current=null; seriesRef.current={}; }
            const chart=L.createChart(containerRef.current,{
              width:containerRef.current.clientWidth||800,
              height:containerRef.current.clientHeight||420,
              layout:{background:{type:'solid',color:'#1f2937'},textColor:'rgba(255,255,255,0.9)'},
              grid:{vertLines:{color:'#374151'},horzLines:{color:'#374151'}},
              crosshair:{mode:L.CrosshairMode.Normal},
              timeScale:{
                borderColor:'#4b5563',
                visible:true,
                timeVisible:true,
                secondsVisible:false,
                tickMarkSpacing:75,
                tickMarkFormatter:(time,markType,locale)=>{
                  // Always display as YY年MM月 (JST)
                  if (typeof time==='object' && time!==null && 'year' in time) {
                    const yy=String(time.year%100).padStart(2,'0');
                    const mm=String(time.month).padStart(2,'0');
                    return `${yy}年${mm}月`;
                  }
                  const ts = (typeof time==='number') ? time : 0; // seconds
                  const d = new Date((ts + 9*3600)*1000); // JST
                  const yy=String((d.getUTCFullYear()%100)).padStart(2,'0');
                  const mm=String(d.getUTCMonth()+1).padStart(2,'0');
                  return `${yy}年${mm}月`;
                }
              },
              localization:{ locale:'ja-JP' },
            });
            const price=chart.addLineSeries({color:'#60a5fa',lineWidth:2});
            const volume=chart.addHistogramSeries({priceFormat:{type:'volume'},priceScaleId:''});
            volume.priceScale().applyOptions({scaleMargins:{top:0.8,bottom:0}});
            const ma50=chart.addLineSeries({color:'rgba(234,179,8,0.9)',lineWidth:2});
            const ma200=chart.addLineSeries({color:'rgba(192,132,252,0.9)',lineWidth:2});
            const showBB = !!loadSettings().chart?.showBB;
            const bbU=chart.addLineSeries({color:'rgba(156,163,175,0.8)',lineWidth:1, visible: showBB});
            const bbM=chart.addLineSeries({color:'rgba(156,163,175,0.8)',lineWidth:1,lineStyle:L.LineStyle.Dotted, visible: showBB});
            const bbL=chart.addLineSeries({color:'rgba(156,163,175,0.8)',lineWidth:1, visible: showBB});
            chartRef.current=chart; seriesRef.current={price,volume,ma50,ma200,bbU,bbM,bbL};
            ro=new ResizeObserver(([e])=>{ if(!e||!chartRef.current) return; const {width,height}=e.contentRect; chartRef.current.applyOptions({width,height}); });
            ro.observe(containerRef.current);
            setLoading(false);
          }catch(e){ console.error(e); setLoading(false); }
        })();
        return ()=>{ disposed=true; if(ro) ro.disconnect(); if(chartRef.current){ chartRef.current.remove(); chartRef.current=null; } seriesRef.current={}; };
      },[stock]);

      useEffect(()=>{
        if(!stock||!seriesRef.current.price) return; let alive=true;
        (async()=>{
          setLoading(true);
          try{
            const raw=await fetchHistoricalData(stock.symbol,timeframe);
            if(!alive||!seriesRef.current.price) { setLoading(false); return; }
            const close=raw.map(d=>({time:d.time,value:d.close}));
            const vol=raw.map(d=>({time:d.time,value:d.value,color:d.color}));
            const ma=(arr,n)=>arr.slice(n-1).map((_,i)=>{const s=arr.slice(i,i+n);const sum=s.reduce((a,v)=>a+v.value,0);return{time:arr[i+n-1].time,value:sum/n};});
            const bb=(arr,n,k)=>arr.slice(n-1).map((_,i)=>{const s=arr.slice(i,i+n).map(x=>x.value);const mean=s.reduce((a,v)=>a+v,0)/n;const std=Math.sqrt(s.reduce((a,v)=>a+Math.pow(v-mean,2),0)/n);return{time:arr[i+n-1].time,upper:mean+k*std,mid:mean,lower:mean-k*std};});
            const {price,volume,ma50,ma200,bbU,bbM,bbL}=seriesRef.current;
            price.setData(close); volume.setData(vol);
            ma50.setData(ma(close,50)); ma200.setData(ma(close,200));
            const bb20=bb(close,20,2);
            bbU.setData(bb20.map(x=>({time:x.time,value:x.upper})));
            bbM.setData(bb20.map(x=>({time:x.time,value:x.mid})));
            bbL.setData(bb20.map(x=>({time:x.time,value:x.lower})));
            // Signal markers
            try {
              const sigs = (signalsMap && signalsMap[stock.symbol] && Array.isArray(signalsMap[stock.symbol].signals)) ? signalsMap[stock.symbol].signals : [];
              const markers = sigs.map(sig=>({ time: sig.date, position: 'belowBar', color: sig.type==='押' ? '#6366f1' : '#34d399', shape: sig.type==='押' ? 'arrowUp' : 'circle', text: sig.type }));
              if (markers.length>0) price.setMarkers(markers);
            } catch(_){ }
            chartRef.current.timeScale().applyOptions({ timeVisible: timeframe==='D', secondsVisible:false });
            chartRef.current.timeScale().fitContent();
          }catch(e){ console.error(e); } finally { if(alive) setLoading(false); }
        })();
        return ()=>{ alive=false };
      },[stock,timeframe]);

      useEffect(()=>{ const onKey=e=>e.key==='Escape'&&onClose(); window.addEventListener('keydown',onKey); return()=>window.removeEventListener('keydown',onKey); },[onClose]);

      if(!stock) return null;
      return (
        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50" onClick={onClose}>
          <div className="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-4xl h-3/4 p-4 flex flex-col" onClick={e=>e.stopPropagation()}>
            <div className="flex justify-between items-center mb-2">
              <h2 className="text-xl font-bold">{stock.name} ({stock.symbol})</h2>
              <div className="flex items-center">
                <div className="bg-gray-700 rounded-md p-1 flex space-x-1 mr-4">
                  {['D','W','M'].map(tf=>(
                    <button key={tf} onClick={()=>setTimeframe(tf)} className={`px-3 py-1 text-sm font-semibold rounded ${timeframe===tf?'bg-indigo-600 text-white':'text-gray-300 hover:bg-gray-600'}`}>
                      {tf==='D'?J('%E6%97%A5'):tf==='W'?J('%E9%80%B1'):J('%E6%9C%88')}
                    </button>
                  ))}
                </div>
                <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl font-bold">&times;</button>
              </div>
            </div>
            <div className="w-full flex-grow relative" ref={containerRef}>
              {loading && (
                <div className="absolute inset-0 flex items-center justify-center bg-gray-800 bg-opacity-80 z-10">
                  <div className="flex items-center"><Loader/><span className="ml-4 text-gray-300">{J('%E3%83%81%E3%83%A3%E3%83%BC%E3%83%88%E3%81%AE%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF%E4%B8%AD...')}</span></div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
  <script>
    (function(){
      try {
        window.addEventListener('message', function(ev){
          try {
            if(!ev || !ev.data) return;
            if (ev.origin !== window.location.origin) return;
            if (ev.data.type === 'analysisSize' && typeof ev.data.height === 'number') {
              var el = document.getElementById('analysisFrame');
              if (el) { el.style.height = Math.max(400, ev.data.height + 4) + 'px'; }
            }
          } catch(e) {}
        });
      } catch(e) {}
    })();
  </script>
</body>
</html>






















