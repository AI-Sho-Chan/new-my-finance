<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MyFinance</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    window.__YF_PROXY__ = window.__YF_PROXY__ || 'http://127.0.0.1:8787/api/yf';
    window.yfGetJSON = async function(pathWithQuery) {
      const base = window.__YF_PROXY__;
      const u = base + pathWithQuery + (pathWithQuery.includes('?') ? '&' : '?') + 'ts=' + Date.now();
      const res = await fetch(u, { cache: 'no-store', headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    }
  </script>
  <style>
    .animate-spin{animation:spin 1s linear infinite}@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  </style>
</head>
<body class="bg-gray-900">
  <div id="root"></div>

  <script type="text/babel">
    const {useState,useEffect,useMemo,useRef} = React;
    const J = (s)=>decodeURIComponent(s);

    // Minimal icons
    const TrendingUp=()=> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>;
    const TrendingDown=()=> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>;
    const Loader=()=> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>;

    // Defaults (a few samples)
    const DEFAULT_ITEMS = [
      {id:'^N225', name:J('%E6%97%A5%E7%B5%8C%E5%B9%B3%E5%9D%87'), symbol:'^N225'},
      {id:'^GSPC', name:'S&P500', symbol:'^GSPC'},
      {id:'AAPL', name:'Apple', symbol:'AAPL'},
      {id:'JPY=X', name:J('%E3%83%89%E3%83%AB%E5%86%86'), symbol:'JPY=X'}
    ];

    // Data fetchers (quote only to keep minimal)
    const asNum = x => (typeof x === 'number' && Number.isFinite(x)) ? x : undefined;
    const fetchMarketData = async (symbols) => {
      try {
        const j = await yfGetJSON(`/quote?symbols=${encodeURIComponent(symbols.join(','))}`);
        const list = j?.quoteResponse?.result || [];
        const out = {};
        for (const q of list) {
          const price = asNum(q.regularMarketPrice);
          const prev = asNum(q.regularMarketPreviousClose);
          const change = (price!=null && prev!=null) ? price - prev : 0;
          const changePercent = (price!=null && prev>0) ? (price-prev)/prev : 0;
          out[q.symbol] = { price, change, changePercent, name: q.longName || q.shortName || q.symbol };
        }
        for(const s of symbols){ if(!out[s]) out[s] = { price:0, change:0, changePercent:0, name:s }; }
        return out;
      } catch(e){
        return symbols.reduce((a,s)=>{ a[s]={ price:0, change:0, changePercent:0, name:s }; return a; },{});
      }
    };

    const TrendingIcon=({trend})=> trend==='up'?<TrendingUp/>: trend==='down'?<TrendingDown/>:<span className="text-gray-400 text-xs">â€”</span>;

    const StockCard=({item,onClick,onRemove})=>{
      const changeAbs = Math.abs(item.changePercent??0);
      const isPos = (item.changePercent??0) >= 0;
      return (
        <div className="bg-gray-800 rounded-lg p-3 shadow-lg cursor-pointer" onClick={onClick}>
          <div className="flex justify-between items-start">
            <div>
              <h3 className="text-sm font-bold text-gray-100 truncate">{item.name}</h3>
              <p className="text-xs text-gray-400">{item.symbol}</p>
            </div>
            <div className={`text-lg ${isPos?'text-green-400':'text-red-400'}`}><TrendingIcon trend={isPos?'up':'down'}/></div>
          </div>
          <div className="flex items-center justify-center py-2">
            <div className={`text-3xl font-bold ${isPos?'text-green-500':'text-red-500'}`}>{(isPos?'+':'-')}{(changeAbs*100).toFixed(1)}%</div>
          </div>
        </div>
      );
    };

    const App=()=>{
      const [watchItems,setWatchItems]=useState(DEFAULT_ITEMS);
      const [watchlist,setWatchlist]=useState([]);
      const [isLoading,setIsLoading]=useState(true);

      useEffect(()=>{ document.title = J('%E3%83%9E%E3%83%8D%E3%83%BC%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%A3%E3%83%BC'); },[]);

      useEffect(()=>{
        (async()=>{
          setIsLoading(true);
          try{
            const market=await fetchMarketData(watchItems.map(i=>i.symbol));
            setWatchlist(watchItems.map(i=>({ ...i, ...(market[i.symbol]||{}) })));
          }finally{ setIsLoading(false); }
        })();
      },[watchItems]);

      return (
        <div className="bg-gray-900 text-white min-h-screen">
          <div className="container mx-auto px-4 pb-20">
            <header className="py-6">
              <h1 className="text-3xl font-bold text-gray-100">{J('%E3%83%9E%E3%83%8D%E3%83%BC%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%A3%E3%83%BC')}</h1>
              <p className="text-md text-gray-400">{J('%E3%81%82%E3%81%AA%E3%81%9F%E3%81%AE%E8%B3%87%E7%94%A3%E3%81%A8%E7%9B%B8%E5%A0%B4%E3%82%92%E3%80%81%E6%89%8B%E5%85%83%E3%81%A7%E6%8A%8A%E6%8F%A1%E3%80%82')}</p>
            </header>
            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
              {isLoading
                ? (<div className="col-span-2 md:col-span-3 lg:col-span-4 flex justify-center items-center h-40"><Loader/><span className="ml-3 text-gray-400">{J('%E5%B8%82%E5%A0%B4%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%8F%96%E5%BE%97%E4%B8%AD...')}</span></div>)
                : watchlist.map(item => (
                    <StockCard key={item.symbol} item={item} onClick={()=>{}} onRemove={()=>{}} />
                  ))
              }
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>

