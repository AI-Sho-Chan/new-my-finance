<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>分析（Scatter + Heatmap）</title>
  <style>
    body{ background:#0f172a; color:#e5e7eb; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; }
    .wrap{ max-width: 1100px; margin: 16px auto; padding: 0 12px; }
    .card{ background:#111827; border:1px solid #374151; border-radius:8px; padding:12px; margin-bottom:16px; }
    .title{ font-weight:700; margin-bottom:8px; }
    .small{ color:#9ca3af; font-size:12px; }
    table{ width:100%; border-collapse: collapse; }
    th,td{ padding:6px 8px; border-top:1px solid #374151; text-align:left; }
    th{ color:#9ca3af; font-weight:600; }
    .chip{ display:inline-block; padding:2px 6px; border-radius:4px; font-weight:600; color:#fff; font-size:12px; }
    .q1{ background:#22c55e; } .q2{ background:#f59e0b; } .q3{ background:#3b82f6; } .q4{ background:#ef4444; }
    .legend span{ margin-right:8px; }
    a{ color:#93c5fd; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="font-size:20px; font-weight:800; margin:8px 0 12px;">相対力ダッシュボード（最小版）</h1>
    <div class="card">
      <div class="title">Scatter（F × V） <span class="small" id="meta"></span></div>
      <div class="legend small" style="margin-bottom:6px;">
        <span class="chip q1">Q1</span>
        <span class="chip q2">Q2</span>
        <span class="chip q3">Q3</span>
        <span class="chip q4">Q4</span>
        <span class="small">（F: 63日リターンのZスコア／V: SMA50 乖離のZスコア）</span>
      </div>
      <svg id="scatter" width="1040" height="420" style="background:#0b1220; border:1px solid #374151; border-radius:6px;"></svg>
    </div>

    <div class="card">
      <div class="title">Heatmap（F / V / A）</div>
      <table id="heat"></table>
    </div>
  </div>

  <script type="module">
  const BASE = (window.__YF_PROXY__ || '/api/yf');
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  async function yf(path){
    const u = BASE + path + (path.includes('?')?'&':'?') + 'ts=' + Date.now();
    for(let i=0;i<2;i++){
      try{ const r = await fetch(u,{ cache:'no-store', headers:{'Accept':'application/json'} }); if(r.ok) return await r.json(); }catch{}; await sleep(200); }
    throw new Error('fetch failed '+path);
  }
  function readWatch(){
    try{ const raw = localStorage.getItem('nmy.watch.items'); const arr = raw? JSON.parse(raw):[]; if(Array.isArray(arr)&&arr.length){ return arr.map(w=>({ symbol:String(w.symbol||''), name:String(w.name||w.symbol||'') })); } }catch{};
    return [ {symbol:'^GSPC',name:'S&P500'}, {symbol:'^N225',name:'日経平均'}, {symbol:'7203.T',name:'トヨタ'}, {symbol:'AAPL',name:'Apple'}, {symbol:'NVDA',name:'NVIDIA'} ];
  }
  function zscore(values){
    const xs = values.filter(v=>Number.isFinite(v)); const n=xs.length; if(!n) return values.map(_=>0);
    const mean = xs.reduce((a,b)=>a+b,0)/n; const sd = Math.sqrt(xs.reduce((a,b)=>a+(b-mean)*(b-mean),0)/n)||1e-9;
    return values.map(v=> Number.isFinite(v) ? Math.max(-3, Math.min(3, (v-mean)/sd )) : 0 );
  }
  async function load(){
    const watch = readWatch();
    const symbols = watch.map(w=>w.symbol);
    const series = await Promise.all(symbols.map(async s=>{ try{
      const j = await yf(`/history?symbol=${encodeURIComponent(s)}&interval=1d&range=1y`);
      const r = j?.chart?.result?.[0]||{}; const ts = r.timestamp||[]; const q=r.indicators?.quote?.[0]||{}; const close=q.close||[];
      const data = []; for(let i=0;i<ts.length;i++){ const c=close[i]; if(Number.isFinite(c)) data.push(c); }
      return { symbol:s, data };
    }catch{ return { symbol:s, data:[] } }}));
    const R63 = []; const Vraw = []; const latest = new Map();
    for(const s of series){ const d=s.data; const n=d.length; if(n===0){ R63.push(NaN); Vraw.push(NaN); continue; }
      latest.set(s.symbol, d[n-1]);
      const r63 = (n>63 && d[n-63]>0)? (d[n-1]/d[n-63] - 1) : NaN; R63.push(r63);
      const win = d.slice(Math.max(0,n-50)); const sma = win.reduce((a,b)=>a+b,0)/(win.length||1); const dev = (sma>0)? (sma - d[n-1])/sma : NaN; Vraw.push(dev);
    }
    const F = zscore(R63); const V = zscore(Vraw); const A = F.map((f,i)=>(f + V[i])/2);
    try{ const q = await yf(`/quote?symbols=${encodeURIComponent(symbols.join(','))}`); const list = q?.quoteResponse?.result||[]; for(const item of list){ if(item?.symbol && item?.longName){ const it=watch.find(w=>w.symbol===item.symbol); if(it) it.name=item.longName; } } }catch{}
    const items = watch.map((w,i)=>({ id:w.symbol, name:w.name, symbol:w.symbol, F:F[i], V:V[i], A:A[i] }));
    renderScatter(items); renderHeat(items);
  }
  function renderScatter(items){
    const svg = document.getElementById('scatter'); while(svg.firstChild) svg.removeChild(svg.firstChild);
    const pad=40, W=+svg.getAttribute('width')||1040, H=+svg.getAttribute('height')||420;
    const w=W-2*pad, h=H-2*pad; const g = document.createElementNS('http://www.w3.org/2000/svg','g'); g.setAttribute('transform',`translate(${pad},${pad})`); svg.appendChild(g);
    const xs = (v)=> (v+3)/6 * w; const ys=(f)=> (1-(f+3)/6) * h;
    const axis = (x1,y1,x2,y2,color)=>{ const l=document.createElementNS('http://www.w3.org/2000/svg','line'); l.setAttribute('x1',x1);l.setAttribute('y1',y1);l.setAttribute('x2',x2);l.setAttribute('y2',y2); l.setAttribute('stroke',color); l.setAttribute('stroke-width','1'); l.setAttribute('opacity','0.6'); g.appendChild(l); };
    axis(0, ys(0), w, ys(0),'#374151'); axis(xs(0),0,xs(0),h,'#374151');
    for(const it of items){ const cx=xs(it.V), cy=ys(it.F); const q = (it.F>=0 && it.V>=0)?'q1': (it.F>=0 && it.V<0)?'q2': (it.F<0 && it.V<0)?'q4':'q3'; const color = q==='q1'? '#22c55e': q==='q2'? '#f59e0b' : q==='q3'? '#3b82f6' : '#ef4444'; const c=document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',6); c.setAttribute('fill',color); c.setAttribute('fill-opacity','0.85'); c.setAttribute('stroke','#0b1220'); c.setAttribute('stroke-width','1'); const t=document.createElementNS('http://www.w3.org/2000/svg','title'); t.textContent = `${it.name} F=${it.F?.toFixed(2)} V=${it.V?.toFixed(2)}`; c.appendChild(t); g.appendChild(c); }
    document.getElementById('meta').textContent = `n=${items.length}`;
  }
  function pctColor(p){ const t=Math.max(0,Math.min(1,p??0.5)); const r=Math.round(239*(1-t)+34*t), g=Math.round(68*(1-t)+197*t), b=Math.round(68*(1-t)+94*t); return `rgb(${r},${g},${b})`; }
  function toPct(vals){ const xs=vals.filter(v=>Number.isFinite(v)); if(!xs.length) return vals.map(_=>null); const sorted=[...xs].sort((a,b)=>a-b); return vals.map(v=>{ if(!Number.isFinite(v)) return null; let i=0; while(i<sorted.length && sorted[i] < v) i++; return (i/(sorted.length-1||1)); }); }
  function renderHeat(items){
    const heat = document.getElementById('heat'); heat.innerHTML='';
    const head = document.createElement('thead'); head.innerHTML = '<tr><th>Asset</th><th>F</th><th>V</th><th>A</th><th>Quad</th></tr>'; heat.appendChild(head);
    const tbody=document.createElement('tbody'); heat.appendChild(tbody);
    const fp = toPct(items.map(i=>i.F)); const vp = toPct(items.map(i=>i.V)); const ap = toPct(items.map(i=>i.A));
    const fmt=(v)=> Number.isFinite(v)? v.toFixed(2): 'N/A';
    items.forEach((it,idx)=>{
      const tr=document.createElement('tr');
      const q = (it.F>=0 && it.V>=0)?'q1': (it.F>=0 && it.V<0)?'q2': (it.F<0 && it.V<0)?'q4':'q3';
      const qlabel = q==='q1'? 'Q1':'Q2'===q? 'Q2': q==='q3'? 'Q3':'Q4';
      tr.innerHTML = `<td>${it.name}</td>`+
        `<td><span class="chip" style="background:${pctColor(fp[idx])}">${fmt(it.F)}</span></td>`+
        `<td><span class="chip" style="background:${pctColor(vp[idx])}">${fmt(it.V)}</span></td>`+
        `<td><span class="chip" style="background:${pctColor(ap[idx])}">${fmt(it.A)}</span></td>`+
        `<td><span class="chip ${q}">${qlabel}</span></td>`;
      tbody.appendChild(tr);
    });
  }
  load().catch(e=>{ document.getElementById('meta').textContent = 'error'; console.error(e); });
  </script>
</body>
</html>
