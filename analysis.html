<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>蛻・梵・・catter + Heatmap・・/title>
  <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAAAFElEQVQoka3MMQ0AAAgDsKf9GQxgq0g1mHc3k3gAAAAASUVORK5CYII=" />
  <style>
    body{ background:#0f172a; color:#e5e7eb; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; }
    .wrap{ max-width: 1100px; margin: 16px auto; padding: 0 12px; }
    .topnav{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .navbtn{ padding:6px 10px; border-radius:8px; background:#1f2937; color:#e5e7eb; border:1px solid #374151; text-decoration:none; margin-right:6px; }
    .navbtn:hover{ background:#374151; }
    .card{ background:#111827; border:1px solid #374151; border-radius:8px; padding:12px; margin-bottom:16px; }
    .title{ font-weight:700; margin-bottom:8px; }
    .small{ color:#9ca3af; font-size:12px; }
    table{ width:100%; border-collapse: collapse; }
    th,td{ padding:6px 8px; border-top:1px solid #374151; text-align:left; }
    th{ color:#9ca3af; font-weight:600; }
    .chip{ display:inline-block; padding:2px 6px; border-radius:4px; font-weight:600; color:#fff; font-size:12px; }
    .q1{ background:#22c55e; } .q2{ background:#f59e0b; } .q3{ background:#3b82f6; } .q4{ background:#ef4444; }
    .legend span{ margin-right:8px; }
    a{ color:#93c5fd; }
    .legend .shape { display:inline-block; width:10px; height:10px; margin-right:4px; vertical-align:middle; }
    .legend .shape.circle{ border-radius:50%; background:currentColor; }
    .legend .shape.square{ background:currentColor; }
    .legend .shape.diamond{ transform: rotate(45deg); background:currentColor; width:8px; height:8px; margin:1px 6px 1px 2px; }
    .legend .shape.triup{ width: 0; height: 0; border-left:6px solid transparent; border-right:6px solid transparent; border-bottom:10px solid currentColor; background:transparent; }
    .legend .shape.tridown{ width: 0; height: 0; border-left:6px solid transparent; border-right:6px solid transparent; border-top:10px solid currentColor; background:transparent; }
  </style>
  <script>
    // Resize helper for iframe parent
    function postSize(){ try{ var h=Math.max(document.documentElement.scrollHeight, document.body.scrollHeight); parent && parent.postMessage({ type:'analysisSize', height:h }, window.location.origin); }catch(e){} }
    window.addEventListener('load', postSize);
    window.addEventListener('resize', postSize);
  </script>
</head>
<body>
  <div class="wrap">
    <div class="topnav">
      <div>
        <a class="navbtn" href="/NMY.html">繝繝・す繝･繝懊・繝・/a>
        <a class="navbtn" href="/NMY.html?tab=assets">雉・肇</a>
        <a class="navbtn" href="/NMY.html?tab=analysis">蛻・梵</a>
        <a class="navbtn" href="/backtest.html">繝舌ャ繧ｯ繝・せ繝・/a>
        <a class="navbtn" href="/NMY.html?tab=settings">險ｭ螳・/a>
      </div>
    </div>
    <h1 style="font-size:20px; font-weight:800; margin:8px 0 12px;">蛻・梵・・catter + Heatmap・・/h1>
    <div class="card">
      <div class="title">Scatter・・ ﾃ・V・・<span class="small" id="meta"></span></div>
      <div class="legend small" style="margin-bottom:6px; display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
        <span class="chip q1">Q1</span>
        <span class="chip q2">Q2</span>
        <span class="chip q3">Q3</span>
        <span class="chip q4">Q4</span>
        <span class="small" style="margin-left:12px; color:#cbd5e1;">蜃｡萓・
          <span style="color:#9ca3af"><span class="shape circle"></span>US譬ｪ</span>
          <span style="color:#9ca3af; margin-left:8px"><span class="shape square"></span>譌･譛ｬ譬ｪ</span>
          <span style="color:#9ca3af; margin-left:8px"><span class="shape diamond"></span>謖・焚/謖・ｨ・/span>
          <span style="color:#9ca3af; margin-left:8px"><span class="shape triup"></span>轤ｺ譖ｿ</span>
          <span style="color:#9ca3af; margin-left:8px"><span class="shape tridown"></span>證怜捷雉・肇</span>
        </span>
        <span class="small">F: 63譌･繝ｪ繧ｿ繝ｼ繝ｳ縺ｮZ繧ｹ繧ｳ繧｢・酬: SMA50荵夜屬縺ｮZ繧ｹ繧ｳ繧｢</span>
      </div>
      <svg id="scatter" height="420" style="width:100%; background:#0b1220; border:1px solid #374151; border-radius:6px;"></svg>
    </div>

    <div class="card">
      <div class="title">Heatmap・・ / V / A・・/div>
      <table id="heat"></table>
    </div>

    <div class="card">
      <div class="title">逕ｨ隱槭→邂怜・譁ｹ豕・/div>
      <div class="small">
        <p><b>F・・orce・・</b> 驕主悉63蝟ｶ讌ｭ譌･縺ｮ繝ｪ繧ｿ繝ｼ繝ｳ繧貞推驫俶氛蜀・〒讓呎ｺ門喧縺励◆Z繧ｹ繧ｳ繧｢縲ゆｾ・ F = zscore(close[t]/close[t-63] - 1)縲よ兜雉・ｮｶ縺ｫ縺ｨ縺｣縺ｦ縺ｯ逶ｴ霑大屁蜊頑悄縺ｮ蜍｢縺・ｒ逶ｸ蟇ｾ豈碑ｼ・☆繧区欠讓吶・/p>
        <p><b>V・・elocity・・</b> 50譌･遘ｻ蜍募ｹｳ蝮・ｼ・MA50・峨↓蟇ｾ縺吶ｋ迴ｾ蝨ｨ蛟､縺ｮ荵夜屬邇・ｒ蜷・釜譟・・縺ｧ讓呎ｺ門喧縺励◆Z繧ｹ繧ｳ繧｢縲ゅ％縺薙〒縺ｯ dev = (SMA50 - 迴ｾ蝨ｨ蛟､) / SMA50 繧剃ｽｿ逕ｨ縺励〃 = zscore(dev)縲ょ､縺御ｽ弱＞・郁ｲ縺ｫ螟ｧ縺阪＞・峨⊇縺ｩ荳頑婿荵夜屬縺悟､ｧ縺阪＞蛯ｾ蜷代・/p>
        <p><b>A・・verage・・</b> F縺ｨV縺ｮ蜊倡ｴ泌ｹｳ蝮・A = (F + V)/2縲ゅΔ繝｡繝ｳ繧ｿ繝縺ｨ繝医Ξ繝ｳ繝我ｽ咲ｽｮ縺ｮ隍・粋謖・ｨ吶・/p>
        <p><b>Q1縲弉4・郁ｱ｡髯撰ｼ・</b> 謨｣蟶・峙縺ｧ F・育ｸｦ・峨→ V・域ｨｪ・峨・隨ｦ蜿ｷ縺ｫ繧医ｊ蛻・｡槭２1: F竕･0, V竕･0縲＿2: F竕･0, V&lt;0縲＿3: F&lt;0, V竕･0縲＿4: F&lt;0, V&lt;0縲・/p>
        <p><b>Z繧ｹ繧ｳ繧｢:</b> 蛟､縺九ｉ蟷ｳ蝮・ｒ蠑輔″讓呎ｺ門￥蟾ｮ縺ｧ蜑ｲ縺｣縺溷､縲よ･ｵ遶ｯ蛟､縺ｮ蠖ｱ髻ｿ繧呈椛縺医ｋ縺溘ａ ﾂｱ3 縺ｫ繧ｯ繝ｪ繝・・縲・/p>
        <p><b>Heatmap縺ｮ濶ｲ:</b> 蜷御ｸ蛻怜・縺ｮ繝代・繧ｻ繝ｳ繧ｿ繧､繝ｫ縺ｧ逹濶ｲ・井ｽ寂・鬮倥〒襍､竊堤ｷ托ｼ峨・/p>
      </div>
      <div class="small" id="dataDate"></div>
    </div>
  </div>

  <script type="module">
  const BASE = (window.__YF_PROXY__ || '/api/yf');
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  function fmtDate(ts){ try{ const d=new Date((Number(ts)||0)*1000); return isNaN(+d)? 'n/a' : d.toISOString().slice(0,10); }catch(_){ return 'n/a'; } }
  async function yf(path){
    const u = BASE + path + (path.includes('?')?'&':'?') + 'ts=' + Date.now();
    for(let i=0;i<2;i++){
      try{ const r = await fetch(u,{ cache:'no-store', headers:{'Accept':'application/json'} }); if(r.ok) return await r.json(); }catch{}; await sleep(200); }
    throw new Error('fetch failed '+path);
  }
  function readWatch(){
    try{ const raw = localStorage.getItem('nmy.watch.items'); const arr = raw? JSON.parse(raw):[]; if(Array.isArray(arr)&&arr.length){ return arr.map(w=>({ symbol:String(w.symbol||''), name:String(w.name||w.symbol||'') })); } }catch{};
    return [ {symbol:'^GSPC',name:'S&P500'}, {symbol:'^N225',name:'譌･邨悟ｹｳ蝮・}, {symbol:'7203.T',name:'繝医Κ繧ｿ'}, {symbol:'AAPL',name:'Apple'}, {symbol:'NVDA',name:'NVIDIA'} ];
  }
  function zscore(values){
    const xs = values.filter(v=>Number.isFinite(v)); const n=xs.length; if(!n) return values.map(_=>0);
    const mean = xs.reduce((a,b)=>a+b,0)/n; const sd = Math.sqrt(xs.reduce((a,b)=>a+(b-mean)*(b-mean),0)/n)||1e-9;
    return values.map(v=> Number.isFinite(v) ? Math.max(-3, Math.min(3, (v-mean)/sd )) : 0 );
  }
  let __itemsCache = [];
  async function load(){
    const watch = readWatch();
    const symbols = watch.map(w=>w.symbol);
    const series = await Promise.all(symbols.map(async s=>{ try{
      const j = await yf(`/history?symbol=${encodeURIComponent(s)}&interval=1d&range=1y`);
      const r = j?.chart?.result?.[0]||{}; const ts = r.timestamp||[]; const q=r.indicators?.quote?.[0]||{}; const close=q.close||[]; const open=q.open||[]; const adj = (r?.indicators?.adjclose?.[0]?.adjclose) || [];
      const data = []; for(let i=0;i<ts.length;i++){ const c = Number.isFinite(adj[i])? adj[i] : close[i]; if(Number.isFinite(c)) data.push(c); }
      return { symbol:s, data, ts, close, open, adj };
    }catch{ return { symbol:s, data:[], ts:[] } }}));
    const R63 = []; const Vraw = []; let latestTs=0;
    for(const s of series){ const d=s.data; const n=d.length; if(n===0){ R63.push(NaN); Vraw.push(NaN); continue; }
      if (Array.isArray(s.ts) && s.ts.length) latestTs = Math.max(latestTs, s.ts[s.ts.length-1]||0);
      const r63 = (n>63 && d[n-63]>0)? (d[n-1]/d[n-63] - 1) : NaN; R63.push(r63);
      const win = d.slice(Math.max(0,n-50)); const sma = win.reduce((a,b)=>a+b,0)/(win.length||1); const dev = (sma>0)? (sma - d[n-1])/sma : NaN; Vraw.push(dev);
    }
    const F = zscore(R63); const V = zscore(Vraw); const A = F.map((f,i)=>(f + V[i])/2);
    try{ const q = await yf(`/quote?symbols=${encodeURIComponent(symbols.join(','))}`); const list = q?.quoteResponse?.result||[]; for(const item of list){ if(item?.symbol && item?.longName){ const it=watch.find(w=>w.symbol===item.symbol); if(it) it.name=item.longName; } } }catch{}
    const items = watch.map((w,i)=>({ id:w.symbol, name:w.name, symbol:w.symbol, F:F[i], V:V[i], A:A[i] }));
    __itemsCache = items;
    renderScatter(items); renderHeat(items); try{ const q1 = items.filter(it=> Number.isFinite(it.F) && Number.isFinite(it.V) && it.F>=0 && it.V>=0).map(it=>it.symbol); parent && parent.postMessage({ type:'analysis:q1set', symbols:q1, at: Date.now() }, window.location.origin); }catch(_){}
    try { await buildAndRenderBacktest(series); } catch(_) {}
    if(latestTs){ const at = document.getElementById('dataDate'); if(at) at.textContent = `菴ｿ逕ｨ繝・・繧ｿ譛邨よ律: ${fmtDate(latestTs)}・・ahoo Finance・荏; }
    setTimeout(postSize, 0);
  }
  function renderScatter(items){
    const svg = document.getElementById('scatter'); while(svg.firstChild) svg.removeChild(svg.firstChild);
    const pad=40; const rect = svg.getBoundingClientRect(); const W = Math.max(360, Math.floor(rect.width)||1040); const H=+svg.getAttribute('height')||420;
    const w=W-2*pad, h=H-2*pad; const g = document.createElementNS('http://www.w3.org/2000/svg','g'); g.setAttribute('transform',`translate(${pad},${pad})`); svg.appendChild(g);
    const xs = (v)=> (v+3)/6 * w; const ys=(f)=> (1-(f+3)/6) * h;
    const axis = (x1,y1,x2,y2,color)=>{ const l=document.createElementNS('http://www.w3.org/2000/svg','line'); l.setAttribute('x1',x1);l.setAttribute('y1',y1);l.setAttribute('x2',x2);l.setAttribute('y2',y2); l.setAttribute('stroke',color); l.setAttribute('stroke-width','1'); l.setAttribute('opacity','0.6'); g.appendChild(l); };
    axis(0, ys(0), w, ys(0),'#374151'); axis(xs(0),0,xs(0),h,'#374151');
    // axis labels
    const tx = document.createElementNS('http://www.w3.org/2000/svg','text'); tx.setAttribute('x', w); tx.setAttribute('y', h+28); tx.setAttribute('fill','#9ca3af'); tx.setAttribute('text-anchor','end'); tx.setAttribute('font-size','12'); tx.textContent='V (Z)'; g.appendChild(tx);
    const ty = document.createElementNS('http://www.w3.org/2000/svg','text'); ty.setAttribute('x', -8); ty.setAttribute('y', 0); ty.setAttribute('fill','#9ca3af'); ty.setAttribute('text-anchor','end'); ty.setAttribute('font-size','12'); ty.setAttribute('transform','rotate(-90)'); ty.textContent='F (Z)'; g.appendChild(ty);
    // class -> shape
    const assetClass=(sym)=>(/=X$/.test(sym)||/-JPY$/.test(sym)?'fx': sym==='BTC-JPY'?'crypto': /^\^/.test(sym)?'index': /\.T$/.test(sym)?'jp':'us');
    for(const it of items){
      const cx=xs(it.V), cy=ys(it.F); const q = (it.F>=0 && it.V>=0)?'q1': (it.F>=0 && it.V<0)?'q2': (it.F<0 && it.V<0)?'q4':'q3'; const color = q==='q1'? '#22c55e': q==='q2'? '#f59e0b' : q==='q3'? '#3b82f6' : '#ef4444'; const cls=assetClass(it.symbol);
      let node;
      if(cls==='us'){ node=document.createElementNS('http://www.w3.org/2000/svg','circle'); node.setAttribute('r',6); node.setAttribute('cx',cx); node.setAttribute('cy',cy); }
      else if(cls==='jp'){ node=document.createElementNS('http://www.w3.org/2000/svg','rect'); node.setAttribute('width',12); node.setAttribute('height',12); node.setAttribute('x',cx-6); node.setAttribute('y',cy-6); node.setAttribute('rx',2); node.setAttribute('ry',2); }
      else if(cls==='index'){ node=document.createElementNS('http://www.w3.org/2000/svg','rect'); node.setAttribute('width',10); node.setAttribute('height',10); node.setAttribute('x',cx-5); node.setAttribute('y',cy-5); node.setAttribute('transform',`rotate(45, ${cx}, ${cy})`); }
      else if(cls==='fx'){ const p=document.createElementNS('http://www.w3.org/2000/svg','path'); p.setAttribute('d',`M ${cx} ${cy-6} L ${cx-6} ${cy+6} L ${cx+6} ${cy+6} Z`); node=p; }
      else { const p=document.createElementNS('http://www.w3.org/2000/svg','path'); p.setAttribute('d',`M ${cx-6} ${cy-4} L ${cx} ${cy+6} L ${cx+6} ${cy-4} Z`); node=p; }
      node.setAttribute('fill',color); node.setAttribute('fill-opacity','0.88'); node.setAttribute('stroke','#0b1220'); node.setAttribute('stroke-width','1');
      const t=document.createElementNS('http://www.w3.org/2000/svg','title'); t.textContent = `${it.name} F=${Number.isFinite(it.F)?it.F.toFixed(2):'N/A'} V=${Number.isFinite(it.V)?it.V.toFixed(2):'N/A'}`; node.appendChild(t); g.appendChild(node);
    }
    // labels for Q1 & Q4 with overlap avoidance
    const placed=[]; const overlap=(a,b)=>!(a.x+a.w<b.x || b.x+b.w<a.x || a.y+a.h<b.y || b.y+b.h<a.y);
    function labelAt(x,y,txt){
      const L=document.createElementNS('http://www.w3.org/2000/svg','text');
      L.setAttribute('x',x+8); L.setAttribute('y',y-8);
      L.setAttribute('fill','#e5e7eb'); L.setAttribute('font-size','11');
      L.setAttribute('paint-order','stroke'); L.setAttribute('stroke','#0b1220'); L.setAttribute('stroke-width','2');
      L.textContent=txt; g.appendChild(L);
      const offs=[[10,-10],[10,10],[-10,-10],[-10,10],[14,0],[-14,0],[0,14],[0,-14],[18,18],[18,-18],[-18,18],[-18,-18]];
      let final={x:x+8,y:y-8};
      for(const [ox,oy] of offs){
        L.setAttribute('x',x+ox); L.setAttribute('y',y+oy);
        const bb=L.getBBox(); const box={x:bb.x,y:bb.y,w:bb.width,h:bb.height};
        if(!placed.some(p=>overlap(box,p))){ placed.push(box); final={x:x+ox,y:y+oy}; break; }
      }
      // leader line
      const line=document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1',x); line.setAttribute('y1',y);
      line.setAttribute('x2',final.x-2); line.setAttribute('y2',final.y-10);
      line.setAttribute('stroke','#64748b'); line.setAttribute('stroke-width','1'); line.setAttribute('opacity','0.7');
      g.insertBefore(line,L);
    }
    for(const it of items){ const cx=xs(it.V), cy=ys(it.F); const q=(it.F>=0 && it.V>=0)?'q1':(it.F>=0 && it.V<0)?'q2':(it.F<0 && it.V<0)?'q4':'q3'; if(q==='q1'||q==='q4'){ labelAt(cx,cy,(it.name||it.symbol).slice(0,12)); } }
    document.getElementById('meta').textContent = `n=${items.length}`;
  }
  function pctColor(p){ const t=Math.max(0,Math.min(1,p??0.5)); const r=Math.round(239*(1-t)+34*t), g=Math.round(68*(1-t)+197*t), b=Math.round(68*(1-t)+94*t); return `rgb(${r},${g},${b})`; }
  function toPct(vals){ const xs=vals.filter(v=>Number.isFinite(v)); if(!xs.length) return vals.map(_=>null); const sorted=[...xs].sort((a,b)=>a-b); return vals.map(v=>{ if(!Number.isFinite(v)) return null; let i=0; while(i<sorted.length && sorted[i] < v) i++; return (i/(sorted.length-1||1)); }); }
  function renderHeat(items){
    const heat = document.getElementById('heat'); heat.innerHTML='';
    const head = document.createElement('thead'); head.innerHTML = '<tr><th>Asset</th><th>F</th><th>V</th><th>A</th><th>Quad</th></tr>'; heat.appendChild(head);
    const tbody=document.createElement('tbody'); heat.appendChild(tbody);
    const rank = (i)=> (i.F>=0 && i.V>=0)?4: (i.F>=0 && i.V<0)?3: (i.F<0 && i.V>=0)?2: 1;
    items = [...items].sort((a,b)=> rank(b)-rank(a));
    const fp = toPct(items.map(i=>i.F)); const vp = toPct(items.map(i=>i.V)); const ap = toPct(items.map(i=>i.A));
    const fmt=(v)=> Number.isFinite(v)? v.toFixed(2): 'N/A';
    items.forEach((it,idx)=>{
      const tr=document.createElement('tr');
      const q = (it.F>=0 && it.V>=0)?'q1': (it.F>=0 && it.V<0)?'q2': (it.F<0 && it.V<0)?'q4':'q3';
      const qlabel = q==='q1'? 'Q1' : q==='q2'? 'Q2' : q==='q3'? 'Q3' : 'Q4';
      tr.innerHTML = `<td>${it.name}</td>`+
        `<td><span class="chip" style="background:${pctColor(fp[idx])}">${fmt(it.F)}</span></td>`+
        `<td><span class="chip" style="background:${pctColor(vp[idx])}">${fmt(it.V)}</span></td>`+
        `<td><span class="chip" style="background:${pctColor(ap[idx])}">${fmt(it.A)}</span></td>`+
        `<td><span class="chip ${q}">${qlabel}</span></td>`;
      tbody.appendChild(tr);
    });
  }
  // --- Backtest: first entry events for Q1 buy / Q4 short ---
  const MAX_HORIZON = 120; // up to ~6繝ｶ譛茨ｼ域ｨｪ繧ｹ繧ｯ繝ｭ繝ｼ繝ｫ蝗樣∩縺ｮ縺溘ａ謚大宛・・  function zByMap(map){ const xs=Object.values(map).filter(v=>Number.isFinite(v)); const n=xs.length; if(!n){ const out={}; for(const k in map) out[k]=NaN; return out; } const mean = xs.reduce((a,b)=>a+b,0)/n; const sd = Math.sqrt(xs.reduce((a,b)=>a+(b-mean)*(b-mean),0)/n)||1e-9; const out={}; for(const k in map){ const v=map[k]; out[k]=Number.isFinite(v)? Math.max(-3, Math.min(3,(v-mean)/sd)) : NaN; } return out; }
  async function openDB(){ return new Promise((res,rej)=>{ const req = indexedDB.open('nmy-analysis',1); req.onupgradeneeded = ()=>{ const db=req.result; if(!db.objectStoreNames.contains('events')) db.createObjectStore('events',{ keyPath:'id' }); }; req.onsuccess=()=>res(req.result); req.onerror=(e)=>rej(e); }); }
  async function putEvents(db, events){ return new Promise((res,rej)=>{ const tx=db.transaction('events','readwrite'); const st=tx.objectStore('events'); for(const ev of events){ st.put(ev); } tx.oncomplete=()=>res(); tx.onerror=(e)=>rej(e); }); }
  async function getAllEvents(db){ return new Promise((res,rej)=>{ const tx=db.transaction('events','readonly'); const st=tx.objectStore('events'); const req=st.getAll(); req.onsuccess=()=>res(req.result||[]); req.onerror=(e)=>rej(e); }); }
  function renderBacktestTable(_events){ /* moved to backtest.html */ }
  async function buildAndRenderBacktest(series){
    // Build fast index per symbol
    const bySym = {}; for(const s of series){ bySym[s.symbol]=s; s.indexByTs={}; for(let i=0;i<(s.ts||[]).length;i++){ s.indexByTs[s.ts[i]]=i; } }
    // Union of timestamps (sorted)
    const setTs=new Set(); for(const s of series){ for(const t of (s.ts||[])) setTs.add(t); }
    const tsAll=[...setTs].sort((a,b)=>a-b);
    const prevQ = {}; const events=[];
    for(const t of tsAll){
      const rmap={}; const vmap={};
      for(const s of series){ const idx=s.indexByTs[t]; if(idx==null) continue; const n=(s.close||[]).length; if(idx>=n) continue; const close=s.close||[]; if(idx>=63 && close[idx-63]>0){ rmap[s.symbol] = close[idx]/close[idx-63]-1; } else { rmap[s.symbol]=NaN; } const winStart=Math.max(0, idx-49); const win = close.slice(winStart, idx+1); const sma = win.reduce((a,b)=>a+(Number.isFinite(b)?b:0),0)/(win.filter(Number.isFinite).length||1); vmap[s.symbol] = (sma>0 && Number.isFinite(close[idx])) ? (sma - close[idx])/sma : NaN; }
      const Fz = zByMap(rmap); const Vz = zByMap(vmap);
      for(const s of series){ const f=Fz[s.symbol], v=Vz[s.symbol]; if(!Number.isFinite(f) || !Number.isFinite(v)) continue; const q = (f>=0 && v>=0)?'Q1': (f>=0 && v<0)?'Q2': (f<0 && v>=0)?'Q3':'Q4'; const prev=prevQ[s.symbol]; prevQ[s.symbol]=q; if((q==='Q1'||q==='Q4') && prev!==q){ // first day entering this quad
          const idx=s.indexByTs[t]; if(idx==null) continue; const nextIdx = idx+1; if(nextIdx >= (s.ts||[]).length) continue; const execTs = s.ts[nextIdx]; const op=(s.open||[])[nextIdx]; const cl=(s.close||[])[nextIdx]; const ad=(s.adj||[])[nextIdx]; const execPrice = Number.isFinite(ad)? ad : (Number.isFinite(op)? op: cl); if(!Number.isFinite(execPrice)) continue; const side = (q==='Q1')? 'BUY':'SHORT';
          const retMap={}; // day -> return
          for(let d=1; d<=365 && nextIdx+d < (s.close||[]).length; d++){ const pxA = (s.adj||[])[nextIdx+d]; const px = Number.isFinite(pxA)? pxA : s.close[nextIdx+d]; if(!Number.isFinite(px)) break; const r = (side==='BUY')? (px/execPrice - 1) : (execPrice/px - 1); retMap[d]=r; }
          events.push({ id: `${s.symbol}:${q}:${execTs}`, symbol:s.symbol, quad:q, side, signalTs:t, execTs, execPrice, returns: retMap });
        }
      }
    }
    // Persist and render
    const db = await openDB();
    const existing = await getAllEvents(db); const exSet = new Set(existing.map(e=>e.id));
    const fresh = events.filter(e=>!exSet.has(e.id)); if(fresh.length) await putEvents(db, fresh);
    const all = [...existing, ...fresh];
    renderBacktestTable(all);
  }
  // Keep in sync with parent app's watchlist and resize with cache
  window.addEventListener('message', (ev)=>{
    try{
      if(!ev || ev.origin !== window.location.origin) return;
      if(ev.data && ev.data.type==='nmy.watch.update' && Array.isArray(ev.data.items)){
        try{ localStorage.setItem('nmy.watch.items', JSON.stringify(ev.data.items)); }catch(_){ }
        load();
      }
    }catch(_){ }
  });
  function injectExtraInfo(){
    try{
      const wrap=document.querySelector('.wrap'); if(!wrap) return;
      const card=document.createElement('div'); card.className='card';
      card.innerHTML = '<div class="title">雎｡髯舌・諢丞袖縺ｨ謗ｨ螂ｨ繧｢繧ｯ繧ｷ繝ｧ繝ｳ</div>'+
        '<div class="small">'+
        '<p><b>Q1:</b> 蜍｢縺・ｂ菴咲ｽｮ繧り憶螂ｽ・・竕･0, V竕･0・峨る・ｼｵ繧翫〒縺ｮ謚ｼ縺礼岼雋ｷ縺・・讀懆ｨ弱・/p>'+
        '<p><b>Q2:</b> 蜍｢縺・・濶ｯ螂ｽ縺縺御ｸ頑婿荵夜屬・・竕･0, V&lt;0・峨ら洒譛溘・蛻ｩ鬟溘＞繝ｻ邵ｮ蟆上ｄ隱ｿ謨ｴ蠕・■縺ｮ讀懆ｨ弱・/p>'+
        '<p><b>Q3:</b> 蜍｢縺・・蠑ｱ縺・′蜑ｲ螳牙ｯ・ｊ・・&lt;0, V竕･0・峨る・ｼｵ繧翫・謇楢ｨｺ繝ｻ逶｣隕門ｼｷ蛹悶・/p>'+
        '<p><b>Q4:</b> 蜍｢縺・ｂ菴咲ｽｮ繧ょｼｱ縺・ｼ・&lt;0, V&lt;0・峨ょ屓驕ｿ繝ｻ邵ｮ蟆上∵綾繧雁｣ｲ繧翫・讀懆ｨ弱・/p>'+
        '<p><b>霆ｸ縺ｮ諢丞袖:</b> 邵ｦ=F・・3譌･繝ｪ繧ｿ繝ｼ繝ｳ縺ｮZ繧ｹ繧ｳ繧｢・峨∵ｨｪ=V・・MA50荵夜屬縺ｮZ繧ｹ繧ｳ繧｢・峨ょ｢・阜邱壹・F=0, V=0縲・/p>'+
        '<p><b>雉・肇繧ｯ繝ｩ繧ｹ縺ｮ蠖｢迥ｶ:</b> US譬ｪ=荳ｸ縲∵律譛ｬ譬ｪ=蝗幄ｧ偵∵欠謨ｰ/謖・ｨ・闖ｱ蠖｢縲∫ぜ譖ｿ=笆ｲ縲∵囓蜿ｷ雉・肇=笆ｼ縲・/p>'+
        '</div>';
      wrap.appendChild(card);
    }catch(_){ }
  }
  load().catch(e=>{ document.getElementById('meta').textContent = 'error'; console.error(e); }).finally(()=>{ setTimeout(postSize,0); injectExtraInfo(); });
  window.addEventListener('resize', ()=>{ try{ renderScatter(__itemsCache||[]); }catch(_){}; setTimeout(postSize,0); });
  </script>
</body>
</html>

