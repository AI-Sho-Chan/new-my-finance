J-Quants を使うAI/コードへの実務的アドバイス（メモ）

- レート制限とトークン失効:
  - 429 連発時は指数的バックオフ（例: 1s, 2s, 4s, 8s … 最大 60s）を実装し、成功後は通常間隔に復帰。
  - バックフィル処理にもクールダウンを入れる。トークン期限切れは即座にトークン更新（リフレッシュ）し再試行。

- 時刻と営業日:
  - タイムゾーンを必ず統一（例: Asia/Tokyo または UTC に正規化）。
  - イベント時刻 → 次営業日 date を厳密に付与する（休日/半休日の考慮）。
  - モデル/ストレージでは tz-naive（UTC 日付など）に統一して取り扱う。

- インクリメンタル取得:
  - 冪等な上書きを前提に同一取得を許容（upsert）。
  - 15 分窓での更新検知（例: parquet の最終更新時刻をヘルスチェックに利用）。

- 学習トリガ:
  - 閾値（更新量やスコア変化など）到達で fin_features → T6 → T7 を自動起動。
  - T6 の OOF はログ/JSON で常時監視し、Status に記録（失敗時は自動リトライ・通知）。

備考:
- J-Quants から取得する株価は分割/配当調整後の価格を使用する方針とし、社内の既存ロジックと整合させる。
- 大量取得の際はフェッチの並列度を制御（例: 3〜5 並列）して API 負荷を避ける。

