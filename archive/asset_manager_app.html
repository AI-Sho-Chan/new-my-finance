<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雉・肇繝槭ロ繝ｼ繧ｸ繝｣繝ｼ</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .switch { 
            position: relative; 
            display: inline-block; 
            width: 60px; 
            height: 34px; 
        }
        .switch input { 
            opacity: 0; 
            width: 0; 
            height: 0; 
        }
        .slider { 
            position: absolute; 
            cursor: pointer; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background-color: #ccc; 
            transition: .4s; 
            border-radius: 34px;
        }
        .slider:before { 
            position: absolute; 
            content: ""; 
            height: 26px; 
            width: 26px; 
            left: 4px; 
            bottom: 4px; 
            background-color: white; 
            transition: .4s; 
            border-radius: 50%;
        }
        input:checked + .slider { 
            background-color: #4f46e5; 
        }
        input:checked + .slider:before { 
            transform: translateX(26px); 
        }
    </style>
</head>
<body class="bg-gray-900">
    <div id="root"></div>

    
        const J = (s) => decodeURIComponent(s);
        const { useState, useEffect, useMemo, useRef } = React;

        /* 笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏
           Lightweight Charts 繝ｭ繝ｼ繝繝ｼ
           笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏 */
        const LWC_URL = 'https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js';
        let __lwcPromise = null;
        const ensureLightweightCharts = () => {
            if (window.LightweightCharts?.createChart) return Promise.resolve(window.LightweightCharts);
            if (__lwcPromise) return __lwcPromise;

            __lwcPromise = new Promise((resolve, reject) => {
                const id = 'lightweight-charts-standalone';
                const existing = document.getElementById(id);
                const onReady = () => {
                    try {
                        const L = window.LightweightCharts;
                        if (!L?.createChart) throw new Error('LightweightCharts missing createChart');
                        const testDiv = document.createElement('div');
                        testDiv.style.cssText = 'position:fixed;left:-9999px;top:-9999px;width:1px;height:1px;';
                        document.body.appendChild(testDiv);
                        const tmp = L.createChart(testDiv, { width: 1, height: 1 });
                        const ok = typeof tmp.addCandlestickSeries === 'function';
                        tmp.remove(); 
                        document.body.removeChild(testDiv);
                        if (!ok) throw new Error('LightweightCharts API incomplete');
                        resolve(L);
                    } catch (e) { reject(e); }
                };

                if (existing) {
                    existing.addEventListener('load', onReady, { once: true });
                    existing.addEventListener('error', () => reject(new Error('LWC script error')), { once: true });
                    if (window.LightweightCharts?.createChart) onReady();
                    return;
                }
                const s = document.createElement('script');
                s.id = id;
                s.src = LWC_URL;
                s.async = true;
                s.crossOrigin = 'anonymous';
                s.addEventListener('load', onReady, { once: true });
                s.addEventListener('error', () => reject(new Error('Failed to load Lightweight Charts')), { once: true });
                document.head.appendChild(s);
            });

            return __lwcPromise;
        };

        /* 笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏
           繧｢繧､繧ｳ繝ｳ繧ｳ繝ｳ繝昴・繝阪Φ繝・           笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏 */
        const TrendingUp = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>;
        const TrendingDown = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></svg>;
        const PlusCircle = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>;
        const SettingsIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>;
        const HomeIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>;
        const PieChartIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>;
        const Loader = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin"><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg>;

        /* 笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏
           蛻晄悄繝・・繧ｿ
           笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏 */
        const initialWatchlistData = [
            { id: 1, name: '譌･邨悟ｹｳ蝮・ｪ萓｡', symbol: '^N225' },
            { id: 1, name: '日経平均株価', symbol: '^N225' },
            { id: 3, name: J('%E3%83%88%E3%83%A8%E3%82%BF%E8%87%AA%E5%8B%95%E8%BB%8A'), symbol: '7203.T' },
            { id: 3, name: 'トヨタ自動車', symbol: '7203.T' },
            { id: 5, name: 'USD/JPY', symbol: 'JPY=X' },
            { id: 6, name: 'S&P 500 VIX', symbol: '^VIX' },
        ];

        const initialPortfolioData = [
                        { id: 'bank1', type: J('%E7%8F%BE%E9%87%91'), name: J('A%E9%8A%80%E8%A1%8C(JPY)'), value: 1500000, details: { currency: 'JPY' }},
                        { id: 'bank1', type: J('%E7%8F%BE%E9%87%91'), name: J('A%E9%8A%80%E8%A1%8C(JPY)'), value: 1500000, details: { currency: 'JPY' }},
                        { id: 'bank2', type: J('%E7%8F%BE%E9%87%91'), name: J('B%E9%8A%80%E8%A1%8C(USD)'), value: 10000, details: { currency: 'USD', symbol: 'JPY=X' }},
                        { id: 'stock1', type: J('%E6%97%A5%E6%9C%AC%E6%A0%AA'), name: J('%E3%82%BD%E3%83%8B%E3%83%BC%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97'), value: 0, details: { symbol: '6758.T', qty: 100, avgPrice: 12500 }},
            { id: 'crypto1', type: '證怜捷雉・肇', name: 'Bitcoin (JPY)', value: 0, details: { symbol: 'BTC-JPY', avgPrice: 8000000, qty: 0.125 }},
            { id: 'crypto1', type: '暗号資産', name: 'Bitcoin (JPY)', value: 0, details: { symbol: 'BTC-JPY', avgPrice: 8000000, qty: 0.125 }},

        /* ======================================================================
           笘・Yahoo Finance 繝・・繧ｿ蜿門ｾ暦ｼ・ORS繝励Ο繧ｭ繧ｷ邨檎罰・・           ====================================================================== */
        
        // 隍・焚縺ｮCORS繝励Ο繧ｭ繧ｷ繧堤畑諢擾ｼ医ヵ繧ｩ繝ｼ繝ｫ繝舌ャ繧ｯ蟇ｾ蠢懶ｼ・        const CORS_PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
        ];

        let currentProxyIndex = 0;

        const fetchWithProxy = async (url, retries = 2) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const proxy = CORS_PROXIES[currentProxyIndex];
                    const response = await fetch(proxy + encodeURIComponent(url), {
                        method: 'GET',
                        headers: {
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        }
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.warn(`Proxy ${currentProxyIndex} failed:`, error);
                    currentProxyIndex = (currentProxyIndex + 1) % CORS_PROXIES.length;
                    if (i === retries - 1) throw error;
                }
            }
        };

        /** 隍・焚驫俶氛縺ｮ繧ｯ繧ｪ繝ｼ繝亥叙蠕・*/
        const fetchMarketData = async (symbols) => {
            try {
                const symbolsStr = symbols.join(',');
                const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbolsStr}`;
                const data = await fetchWithProxy(url);
                
                const list = data?.quoteResponse?.result || [];
                const out = {};
                
                for (const q of list) {
                    const price = q.regularMarketPrice ?? q.postMarketPrice ?? q.preMarketPrice ?? null;
                    const change = q.regularMarketChange ?? null;
                    const changePercent = q.regularMarketChangePercent != null ? 
                        (q.regularMarketChangePercent / 100) : null;

                    out[q.symbol] = {
                        price: price,
                        change: change,
                        changePercent: changePercent,
                        trend: (change ?? 0) >= 0 ? 'up' : 'down',
                        name: q.longName || q.shortName || q.symbol,
                        per: (typeof q.trailingPE === 'number') ? q.trailingPE : undefined,
                        pbr: (typeof q.priceToBook === 'number') ? q.priceToBook : undefined,
                        dividendYield: (typeof q.trailingAnnualDividendYield === 'number') ? 
                            q.trailingAnnualDividendYield : undefined,
                        marketCap: q.marketCap,
                    };
                }
                return out;
            } catch (error) {
                console.error('Failed to fetch market data:', error);
                // 繝輔か繝ｼ繝ｫ繝舌ャ繧ｯ・壹ム繝溘・繝・・繧ｿ繧定ｿ斐☆
                return symbols.reduce((acc, symbol) => {
                    acc[symbol] = {
                        price: 100 + Math.random() * 100,
                        change: (Math.random() - 0.5) * 10,
                        changePercent: (Math.random() - 0.5) * 0.1,
                        trend: Math.random() > 0.5 ? 'up' : 'down',
                        name: symbol,
                        per: 15 + Math.random() * 20,
                        pbr: 1 + Math.random() * 3,
                        dividendYield: Math.random() * 0.05,
                        marketCap: 1000000000 + Math.random() * 10000000000
                    };
                    return acc;
                }, {});
            }
        };

        /** 譎らｳｻ蛻励ョ繝ｼ繧ｿ蜿門ｾ・*/
        const fetchHistoricalData = async (symbol, timeframe) => {
            try {
                const tf = timeframe === 'W' ? { interval: '1wk', range: '2y' }
                         : timeframe === 'M' ? { interval: '1mo', range: '5y' }
                         :                     { interval: '1d',  range: '1y' };
                
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=${tf.interval}&range=${tf.range}`;
                const data = await fetchWithProxy(url);
                
                const result = data?.chart?.result?.[0];
                const ts = result?.timestamp || [];
                const qt = result?.indicators?.quote?.[0] || {};
                const open = qt.open || [];
                const high = qt.high || [];
                const low = qt.low || [];
                const close = qt.close || [];
                const volume = qt.volume || [];

                const out = [];
                for (let i = 0; i < ts.length; i++) {
                    const o = open[i], h = high[i], l = low[i], c = close[i], v = volume[i];
                    if ([o,h,l,c].some(x => x == null)) continue;
                    out.push({
                        time: ts[i],
                        open: o, high: h, low: l, close: c,
                        value: v ?? 0,
                        color: c >= o ? 'rgba(0,150,136,0.2)' : 'rgba(255,82,82,0.2)',
                    });
                }
                return out;
            } catch (error) {
                console.error('Failed to fetch historical data:', error);
                // 繝輔か繝ｼ繝ｫ繝舌ャ繧ｯ・壹ム繝溘・繝・・繧ｿ逕滓・
                const out = [];
                const basePrice = 100;
                const now = Date.now();
                const days = timeframe === 'W' ? 104 : timeframe === 'M' ? 60 : 252;
                
                for (let i = days; i >= 0; i--) {
                    const time = Math.floor((now - i * 24 * 60 * 60 * 1000) / 1000);
                    const price = basePrice + Math.sin(i / 10) * 20 + (Math.random() - 0.5) * 10;
                    const open = price + (Math.random() - 0.5) * 5;
                    const close = price + (Math.random() - 0.5) * 5;
                    const high = Math.max(open, close) + Math.random() * 3;
                    const low = Math.min(open, close) - Math.random() * 3;
                    
                    out.push({
                        time: time,
                        open: open,
                        high: high,
                        low: low,
                        close: close,
                        value: Math.floor(Math.random() * 1000000),
                        color: close >= open ? 'rgba(0,150,136,0.2)' : 'rgba(255,82,82,0.2)',
                    });
                }
                return out;
            }
        };

        /* 笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏
           繝｡繧､繝ｳ繧｢繝励Μ繧ｱ繝ｼ繧ｷ繝ｧ繝ｳ
           笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏 */
        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [watchlist, setWatchlist] = useState([]);
            const [portfolio, setPortfolio] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [selectedStock, setSelectedStock] = useState(null);

            useEffect(() => {
                const fetchData = async () => {
                    setIsLoading(true);
                    const watchlistSymbols = initialWatchlistData.map(i => i.symbol);
                    const portfolioSymbols = initialPortfolioData.filter(i => i.details.symbol).map(i => i.details.symbol);
                    const allSymbols = [...new Set([...watchlistSymbols, ...portfolioSymbols])];

                    try {
                        const marketData = await fetchMarketData(allSymbols);

                        setWatchlist(
                            initialWatchlistData.map(i => {
                                const d = marketData[i.symbol] || {};
                                return { ...i, ...d, name: d.name || i.name };
                            })
                        );

                        setPortfolio(
                            initialPortfolioData.map(a => {
                                if (!a.details.symbol) return a;
                                const d = marketData[a.details.symbol];
                                if (!d) return a;
                                if (a.type === '迴ｾ驥・ && a.details.currency === 'USD') {
                                    return { ...a, details: { ...a.details, rate: d.price } };
                                }
                                const currentValue = (d.price ?? 0) * (a.details.qty ?? 0);
                                const cost = (a.details.avgPrice ?? 0) * (a.details.qty ?? 0);
                                const gainLossPercent = cost > 0 ? ((currentValue - cost) / cost) * 100 : 0;
                                return { ...a, value: currentValue, gainLossPercent };
                            })
                        );

                    } catch (e) {
                        console.error('Failed to fetch market data:', e);
                        setWatchlist(initialWatchlistData);
                        setPortfolio(initialPortfolioData);
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchData();
            }, []);

            const handleCardClick = (stock) => { 
                setSelectedStock(stock); 
                setIsModalOpen(true); 
            };
            
            const closeModal = () => { 
                setIsModalOpen(false); 
                setSelectedStock(null); 
            };

            const renderContent = () => {
                if (isLoading) {
                    return (
                        <div className="flex justify-center items-center h-64">
                            <Loader />
                            <span className="ml-4 text-lg text-gray-400">蟶ょｴ繝・・繧ｿ繧貞叙蠕嶺ｸｭ...</span>
                        </div>
                    );
                }
                switch (activeTab) {
                    case 'dashboard': return <Dashboard watchlist={watchlist} onCardClick={handleCardClick} />;
                    case 'portfolio': return <Portfolio portfolio={portfolio} />;
                    case 'settings': return <Settings />;
                    default: return <Dashboard watchlist={watchlist} onCardClick={handleCardClick} />;
                }
            };

            return (
                <div className="bg-gray-900 text-white min-h-screen font-sans antialiased">
                    <div className="container mx-auto px-4 pb-20">
                        <Header />
                        <main>{renderContent()}</main>
                    </div>
                    <BottomNav activeTab={activeTab} setActiveTab={setActiveTab} />
                    {isModalOpen && <StockChartModal stock={selectedStock} onClose={closeModal} />}
                </div>
            );
        };

        const Header = () => (
            <header className="py-6">
                <h1 className="text-3xl font-bold text-gray-100">雉・肇繝槭ロ繝ｼ繧ｸ繝｣繝ｼ</h1>
                <p className="text-md text-gray-400">縺ゅ↑縺溘・雉・肇縺ｨ蟶ょｴ繧偵√％縺薙↓髮・ｴ・・/p>
            </header>
        );

        const Dashboard = ({ watchlist, onCardClick }) => (
            <div>
                <h2 className="text-2xl font-semibold mb-4 text-gray-200">繝繝・す繝･繝懊・繝・/h2>
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 md:gap-4">
                    {watchlist.map((item) => (
                        <StockCard key={item.id} item={item} onClick={() => onCardClick(item)} />
                    ))}
                </div>
            </div>
        );

        const TrendingIcon = ({ trend }) => trend === 'up' ? <TrendingUp /> : <TrendingDown />;

        const StockCard = ({ item, onClick }) => {
            const changePercentAbs = Math.abs(item.changePercent ?? 0);
            const isPositive = (item.changePercent ?? 0) >= 0;
            const isVolatile = (changePercentAbs * 100) >= 5;

            const cardStyle = `
                bg-gray-800 rounded-lg p-3 shadow-lg transform hover:scale-105 transition-transform duration-300 cursor-pointer
                flex flex-col justify-between h-full aspect-[4/5]
                ${isVolatile ? 'ring-2 ring-yellow-400 shadow-yellow-400/20' : ''}
            `;

            return (
                <div className={cardStyle} onClick={onClick}>
                    <div className="flex justify-between items-start">
                        <div className="w-4/5">
                            <h3 className="text-sm font-bold text-gray-100 truncate">{item.name}</h3>
                            <p className="text-xs text-gray-400">{item.symbol}</p>
                        </div>
                        <div className={`text-lg flex items-center ${isPositive ? 'text-green-400' : 'text-red-400'}`}>
                            <TrendingIcon trend={isPositive ? 'up' : 'down'} />
                        </div>
                    </div>

                    <div className="flex-grow flex items-center justify-center my-1">
                        <div className={`text-3xl md:text-4xl font-bold ${isPositive ? 'text-green-500' : 'text-red-500'}`}>
                            {isPositive ? '+' : '-'}{(changePercentAbs * 100).toFixed(1)}%
                        </div>
                    </div>

                    <div className="text-xs text-gray-400 pt-2 border-t border-gray-700 space-y-1">
                        <div className="flex justify-between">
                            <span className="font-semibold">PER</span> 
                            <span className="text-gray-200 font-medium">
                                {typeof item.per === 'number' ? item.per.toFixed(2) : '-'}
                            </span>
                        </div>
                        <div className="flex justify-between">
                            <span className="font-semibold">PBR</span> 
                            <span className="text-gray-200 font-medium">
                                {typeof item.pbr === 'number' ? item.pbr.toFixed(2) : '-'}
                            </span>
                        </div>
                        <div className="flex justify-between">
                            <span className="font-semibold">驟榊ｽ灘茜蝗・/span> 
                            <span className="text-gray-200 font-medium">
                                {typeof item.dividendYield === 'number' ? 
                                    `${(item.dividendYield*100).toFixed(2)}%` : '-'}
                            </span>
                        </div>
                        <div className="flex justify-between">
                            <span className="font-semibold truncate" title="譎ゆｾ｡邱城｡・>譎ゆｾ｡邱城｡・/span> 
                            <span className="text-gray-200 font-medium">
                                {item.marketCap ? 
                                    (item.marketCap / 1e8).toLocaleString('ja-JP', { maximumFractionDigits: 2 }) + '蜆・ : '-'}
                            </span>
                        </div>
                    </div>
                </div>
            );
        };

        const Portfolio = ({ portfolio }) => {
            const totalValue = useMemo(() => portfolio.reduce((sum, asset) => {
                if (asset.type === '迴ｾ驥・ && asset.details.currency === 'USD') 
                    return sum + (asset.value * (asset.details.rate || 150));
                return sum + asset.value;
            }, 0), [portfolio]);

            const cashValue = useMemo(() => portfolio.filter(a => a.type === '迴ｾ驥・).reduce((sum, asset) => {
                if (asset.details.currency === 'USD') 
                    return sum + (asset.value * (asset.details.rate || 150));
                return sum + asset.value;
            }, 0), [portfolio]);

            const investmentValue = totalValue - cashValue;
            const totalChange = 25340;
            const totalChangePercent = (totalChange / (totalValue - totalChange)) * 100;

            return (
                <div>
                    <div className="bg-gray-800 p-4 rounded-lg mb-6">
                        <div className="text-gray-400 text-sm">邱剰ｳ・肇鬘・(JPY)</div>
                        <div className="text-3xl font-bold text-white">ﾂ･ {totalValue.toLocaleString()}</div>
                        <div className={`text-md font-semibold mt-1 ${totalChange >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                            {totalChange >= 0 ? '+' : ''}ﾂ･{Math.abs(totalChange).toLocaleString()} 
                            ({totalChange >= 0 ? '+' : ''}{totalChangePercent.toFixed(2)}%)
                            <span className="text-sm text-gray-500 ml-2">蟇ｾ蜑肴律豈・/span>
                        </div>
                        <div className="flex justify-between mt-4 pt-4 border-t border-gray-700 text-base">
                            <div className="text-green-400">迴ｾ驥・ ﾂ･ {cashValue.toLocaleString()}</div>
                            <div className="text-blue-400">謚戊ｳ・ ﾂ･ {investmentValue.toLocaleString()}</div>
                        </div>
                    </div>

                    <div className="bg-gray-800 p-4 rounded-lg mb-6 h-64 flex items-center justify-center">
                        <p className="text-gray-500">雉・肇謗ｨ遘ｻ繧ｰ繝ｩ繝・/p>
                    </div>

                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-semibold text-gray-200">雉・肇荳隕ｧ</h2>
                        <button className="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                            <PlusCircle />
                            <span className="ml-2">霑ｽ蜉</span>
                        </button>
                    </div>

                    <div className="space-y-3">
                        {portfolio.map(asset => {
                            const isUsdCash = asset.type === '迴ｾ驥・ && asset.details.currency === 'USD';
                            let displayValue = isUsdCash ? asset.value * (asset.details.rate || 0) : asset.value;
                            return (
                                <div key={asset.id} className="bg-gray-800 rounded-lg p-4 flex justify-between items-center">
                                    <div>
                                        <p className="font-bold text-gray-100">{asset.name}</p>
                                        <p className="text-sm text-gray-400">{asset.type}</p>
                                    </div>
                                    <div className="text-right">
                                        <p className="font-bold text-lg text-gray-50">
                                            {isUsdCash ? "¥" : (asset.details.currency === "USD" ? "$" : "¥")}
                                            {displayValue.toLocaleString(undefined, { maximumFractionDigits: 2 })}
                                        </p>
                                        {isUsdCash && (<p className="text-sm text-gray-400">($ {asset.value.toLocaleString()})</p>)}
                                        {asset.gainLossPercent !== undefined && (
                                            <p className={`font-semibold text-sm ${asset.gainLossPercent >= 0 ? 'text-green-500' : 'text-red-500'}`}>
                                                {asset.gainLossPercent >= 0 ? '+' : ''}{asset.gainLossPercent.toFixed(2)}%
                                            </p>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const Settings = () => (
            <div>
                <h2 className="text-2xl font-semibold mb-4 text-gray-200">險ｭ螳・/h2>
                <div className="bg-gray-800 rounded-lg p-4">
                    <h3 className="text-lg font-bold mb-2">繧｢繝ｩ繝ｼ繝郁ｨｭ螳・/h3>
                    <div className="flex justify-between items-center">
                        <p>S&P 500 VIX謖・焚縺・0繧定ｶ・∴縺溘ｉ騾夂衍</p>
                        <label className="switch">
                            <input type="checkbox" defaultChecked />
                            <span className="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        );

        const BottomNav = ({ activeTab, setActiveTab }) => {
            const navItems = [
                { id: 'dashboard', label: '繝繝・す繝･繝懊・繝・, icon: <HomeIcon /> },
                { id: 'portfolio', label: '雉・肇邂｡逅・, icon: <PieChartIcon /> },
                { id: 'settings', label: '險ｭ螳・, icon: <SettingsIcon /> },
            ];
            
            return (
                <nav className="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 shadow-lg">
                    <div className="flex justify-around max-w-lg mx-auto">
                        {navItems.map(item => (
                            <button
                                key={item.id}
                                onClick={() => setActiveTab(item.id)}
                                className={`flex flex-col items-center justify-center w-full pt-2 pb-1 ${
                                    activeTab === item.id ? 'text-indigo-400' : 'text-gray-400'
                                }`}
                            >
                                {item.icon}
                                <span className="text-xs">{item.label}</span>
                            </button>
                        ))}
                    </div>
                </nav>
            );
        };

        /* 笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏
           繝√Ε繝ｼ繝医Δ繝ｼ繝繝ｫ
           笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏 */
        const StockChartModal = ({ stock, onClose }) => {
            const containerRef = useRef(null);
            const chartRef = useRef(null);
            const seriesRef = useRef({});
            const [timeframe, setTimeframe] = useState('D');
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!stock) return;
                let disposed = false;
                let ro;

                (async () => {
                    setLoading(true);
                    try {
                        const L = await ensureLightweightCharts();
                        await new Promise(resolve => requestAnimationFrame(resolve));
                        if (disposed || !containerRef.current) return;

                        if (chartRef.current) { 
                            chartRef.current.remove(); 
                            chartRef.current = null; 
                            seriesRef.current = {}; 
                        }

                        const chart = L.createChart(containerRef.current, {
                            width: containerRef.current.clientWidth || 800,
                            height: containerRef.current.clientHeight || 420,
                            layout: { 
                                backgroundColor: '#1f2937', 
                                textColor: 'rgba(255,255,255,0.9)' 
                            },
                            grid: { 
                                vertLines: { color: '#374151' }, 
                                horzLines: { color: '#374151' } 
                            },
                            crosshair: { mode: L.CrosshairMode.Normal },
                            timeScale: { borderColor: '#4b5563' },
                        });
                        
                        if (typeof chart.addCandlestickSeries !== 'function') 
                            throw new Error('chart API invalid');

                        const candle = chart.addCandlestickSeries({
                            upColor: '#10b981', 
                            downColor: '#ef4444',
                            borderUpColor: '#10b981', 
                            borderDownColor: '#ef4444',
                            wickUpColor: '#10b981', 
                            wickDownColor: '#ef4444',
                        });
                        
                        const volume = chart.addHistogramSeries({ 
                            priceFormat: { type: 'volume' }, 
                            priceScaleId: '' 
                        });
                        volume.priceScale().applyOptions({ 
                            scaleMargins: { top: 0.8, bottom: 0 } 
                        });
                        
                        const ma50 = chart.addLineSeries({ 
                            color: 'rgba(234,179,8,0.8)', 
                            lineWidth: 2 
                        });
                        const ma200 = chart.addLineSeries({ 
                            color: 'rgba(192,132,252,0.8)', 
                            lineWidth: 2 
                        });
                        const bbU = chart.addLineSeries({ 
                            color: 'rgba(56,189,248,0.5)', 
                            lineWidth: 1 
                        });
                        const bbL = chart.addLineSeries({ 
                            color: 'rgba(56,189,248,0.5)', 
                            lineWidth: 1 
                        });

                        chartRef.current = chart;
                        seriesRef.current = { candle, volume, ma50, ma200, bbU, bbL };

                        ro = new ResizeObserver(([e]) => {
                            if (!e || !chartRef.current) return;
                            const { width, height } = e.contentRect;
                            chartRef.current.applyOptions({ width, height });
                        });
                        ro.observe(containerRef.current);

                        setLoading(false);
                    } catch (err) { 
                        console.error('Failed to initialize chart:', err); 
                        setLoading(false); 
                    }
                })();

                return () => {
                    disposed = true;
                    if (ro) ro.disconnect();
                    if (chartRef.current) { 
                        chartRef.current.remove(); 
                        chartRef.current = null; 
                    }
                    seriesRef.current = {};
                };
            }, [stock]);

            useEffect(() => {
                if (!stock || !seriesRef.current.candle) return;
                let alive = true;

                (async () => {
                    setLoading(true);
                    try {
                        const raw = await fetchHistoricalData(stock.symbol, timeframe);
                        if (!alive || !seriesRef.current.candle) { 
                            setLoading(false); 
                            return; 
                        }

                        const ohlc = raw.map(d => ({ 
                            time: d.time, 
                            open: d.open, 
                            high: d.high, 
                            low: d.low, 
                            close: d.close 
                        }));
                        const vol = raw.map(d => ({ 
                            time: d.time, 
                            value: d.value, 
                            color: d.color 
                        }));

                        const ma = (arr, n) =>
                            arr.slice(n - 1).map((_, i) => {
                                const slice = arr.slice(i, i + n);
                                const sum = slice.reduce((s, v) => s + v.close, 0);
                                return { time: arr[i + n - 1].time, value: sum / n };
                            });

                        const bb = (arr, n, k) =>
                            arr.slice(n - 1).map((_, i) => {
                                const slice = arr.slice(i, i + n);
                                const mean = slice.reduce((s, v) => s + v.close, 0) / n;
                                const std = Math.sqrt(slice.reduce((s, v) => s + Math.pow(v.close - mean, 2), 0) / n);
                                return { 
                                    time: arr[i + n - 1].time, 
                                    upper: mean + k * std, 
                                    lower: mean - k * std 
                                };
                            });

                        const { candle, volume, ma50, ma200, bbU, bbL } = seriesRef.current;
                        candle.setData(ohlc);
                        volume.setData(vol);
                        ma50.setData(ma(ohlc, 50));
                        ma200.setData(ma(ohlc, 200));
                        const bb20 = bb(ohlc, 20, 2);
                        bbU.setData(bb20.map(x => ({ time: x.time, value: x.upper })));
                        bbL.setData(bb20.map(x => ({ time: x.time, value: x.lower })));

                        chartRef.current.timeScale().fitContent();
                    } catch (e) {
                        console.error('Failed to fetch/render data:', e);
                    } finally {
                        if (alive) setLoading(false);
                    }
                })();

                return () => { alive = false; };
            }, [stock, timeframe]);

            useEffect(() => {
                const onKey = e => e.key === 'Escape' && onClose();
                window.addEventListener('keydown', onKey);
                return () => window.removeEventListener('keydown', onKey);
            }, [onClose]);

            if (!stock) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50" onClick={onClose}>
                    <div className="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-4xl h-3/4 p-4 flex flex-col" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-2">
                            <h2 className="text-xl font-bold">{stock.name} ({stock.symbol})</h2>
                            <div className="flex items-center">
                                <div className="bg-gray-700 rounded-md p-1 flex space-x-1 mr-4">
                                    {['D','W','M'].map(tf => (
                                        <button 
                                            key={tf} 
                                            onClick={() => setTimeframe(tf)}
                                            className={`px-3 py-1 text-sm font-semibold rounded ${
                                                timeframe === tf ? 'bg-indigo-600 text-white' : 'text-gray-300 hover:bg-gray-600'
                                            }`}
                                        >
                                            {tf === 'D' ? '譌･' : tf === 'W' ? '騾ｱ' : '譛・}
                                        </button>
                                    ))}
                                </div>
                                <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl font-bold">
                                    &times;
                                </button>
                            </div>
                        </div>
                        <div className="w-full flex-grow relative" ref={containerRef}>
                            {loading && (
                                <div className="absolute inset-0 flex items-center justify-center bg-gray-800 bg-opacity-80 z-10">
                                    <Loader />
                                    <span className="ml-4 text-gray-300">繝√Ε繝ｼ繝医ョ繝ｼ繧ｿ繧定ｪｭ縺ｿ霎ｼ縺ｿ荳ｭ...</span>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 繧｢繝励Μ繧ｱ繝ｼ繧ｷ繝ｧ繝ｳ縺ｮ繝ｬ繝ｳ繝繝ｪ繝ｳ繧ｰ
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>



